<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

<!-- Supabase v2 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: sans-serif; padding: 30px; }
input, button { padding: 6px; margin: 4px; }
table { border-collapse: collapse; margin-bottom: 30px; width: 900px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #f0f0f0; }
.low { background: #ffe5e5; color: #c00; font-weight: bold; }
</style>
</head>

<body>

<h1>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

<div>
  ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼š
  <input id="userInput" placeholder="ä¾‹ï¼šå±±ç”°">
</div>

<h2>å…¥åº«</h2>
<input id="nameInput" placeholder="å•†å“å">
<input id="qtyInput" type="number" placeholder="æ•°é‡">
<button onclick="addItem()">å…¥åº«</button>

<h2>åœ¨åº«ä¸€è¦§</h2>
<table id="stockTable"></table>

<h2>å…¥å‡ºåº«å±¥æ­´</h2>
<table id="historyTable"></table>

<script>
/* =========================
   ğŸ”‘ Supabase æ¥ç¶šè¨­å®š
   ========================= */
const SUPABASE_URL = "https://dabhwrkugxxbkvwlcyxi.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhYmh3cmt1Z3h4Ymt2d2xjeXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjAwNjksImV4cCI6MjA4Mjg5NjA2OX0.G60_QQy0SOY7w-72Mq-gMoq99kUPj1I6c13G2SxOHeQ";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const ALERT_QTY = 3;

/* =========================
   åˆæœŸãƒ­ãƒ¼ãƒ‰
   ========================= */
window.onload = () => {
  loadAll();
};

/* =========================
   ãƒ‡ãƒ¼ã‚¿å–å¾—
   ========================= */
async function loadAll() {
  const { data: stocks, error: sErr } =
    await supabaseClient.from("stocks").select("*").order("name");

  const { data: history, error: hErr } =
    await supabaseClient.from("history")
      .select("*")
      .order("date", { ascending: false });

  if (sErr || hErr) {
    alert("Supabaseé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆConsoleã‚’ç¢ºèªï¼‰");
    console.error(sErr, hErr);
    return;
  }

  renderStocks(stocks);
  renderHistory(history);
}

/* =========================
   å…¥åº«
   ========================= */
async function addItem() {
  const name = nameInput.value.trim();
  const qty = Number(qtyInput.value);
  const user = userInput.value || "æœªå…¥åŠ›";

  if (!name || !qty) {
    alert("å•†å“åã¨æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const { data: existing } = await supabaseClient
    .from("stocks")
    .select("*")
    .eq("name", name)
    .single();

  if (existing) {
    await supabaseClient
      .from("stocks")
      .update({ qty: existing.qty + qty })
      .eq("id", existing.id);
  } else {
    await supabaseClient
      .from("stocks")
      .insert({ name, qty });
  }

  await supabaseClient.from("history").insert({
    date: new Date(),
    user,
    type: "å…¥åº«",
    name,
    qty
  });

  nameInput.value = "";
  qtyInput.value = "";

  loadAll();
}

/* =========================
   å‡ºåº«
   ========================= */
async function shipItem(name) {
  const user = userInput.value || "æœªå…¥åŠ›";

  const { data } = await supabaseClient
    .from("stocks")
    .select("*")
    .eq("name", name)
    .single();

  if (!data) return;

  const newQty = data.qty - 1;

  if (newQty <= 0) {
    await supabaseClient
      .from("stocks")
      .delete()
      .eq("id", data.id);
  } else {
    await supabaseClient
      .from("stocks")
      .update({ qty: newQty })
      .eq("id", data.id);
  }

  await supabaseClient.from("history").insert({
    date: new Date(),
    user,
    type: "å‡ºåº«",
    name,
    qty: 1
  });

  loadAll();
}

/* =========================
   è¡¨ç¤º
   ========================= */
function renderStocks(stocks) {
  stockTable.innerHTML =
    "<tr><th>å•†å“</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr>";

  stocks.forEach(s => {
    const tr = stockTable.insertRow();
    if (s.qty <= ALERT_QTY) tr.className = "low";

    tr.innerHTML = `
      <td>${s.name}</td>
      <td>${s.qty}</td>
      <td>
        <button onclick="shipItem('${s.name}')">å‡ºåº«</button>
      </td>
    `;
  });
}

function renderHistory(history) {
  historyTable.innerHTML =
    "<tr><th>æ—¥æ™‚</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>ç¨®åˆ¥</th><th>å•†å“</th><th>æ•°é‡</th></tr>";

  history.forEach(h => {
    const tr = historyTable.insertRow();
    tr.innerHTML = `
      <td>${h.date}</td>
      <td>${h.user}</td>
      <td>${h.type}</td>
      <td>${h.name}</td>
      <td>${h.qty}</td>
    `;
  });
}
</script>

</body>
</html>
