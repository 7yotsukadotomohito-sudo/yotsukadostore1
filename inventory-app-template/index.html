<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>在庫管理システム</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body { font-family: sans-serif; padding: 30px; }
input, button { padding: 6px; margin: 3px; }
table { border-collapse: collapse; margin-bottom: 30px; width: 900px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #f0f0f0; }
.low { background: #ffe5e5; color: #c00; font-weight: bold; }
</style>
</head>

<body>

<h1>在庫管理システム</h1>

ユーザー名：
<input id="userInput" placeholder="例：山田">

<h2>入庫</h2>
<input id="nameInput" placeholder="商品名">
<input id="qtyInput" type="number" placeholder="数量">
<button onclick="addItem()">入庫</button>

<table id="stockTable"></table>

<h2>入出庫履歴</h2>
<table id="historyTable"></table>

<script>
const supabase = supabasejs.createClient(
  "https://dabhwrkugxxbkvwlcyxi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhYmh3cmt1Z3h4Ymt2d2xjeXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjAwNjksImV4cCI6MjA4Mjg5NjA2OX0.G60_QQy0SOY7w-72Mq-gMoq99kUPj1I6c13G2SxOHeQ"
);

const ALERT_QTY = 3;

async function loadAll() {
  const { data: stocks } = await supabase.from("stocks").select("*");
  const { data: history } = await supabase.from("history").select("*").order("date", { ascending: false });
  renderStocks(stocks);
  renderHistory(history);
}

async function addItem() {
  const name = nameInput.value;
  const qty = Number(qtyInput.value);
  if (!name || !qty) return;

  const { data } = await supabase.from("stocks").select("*").eq("name", name).single();

  if (data) {
    await supabase.from("stocks").update({ qty: data.qty + qty }).eq("id", data.id);
  } else {
    await supabase.from("stocks").insert({ name, qty });
  }

  await supabase.from("history").insert({
    date: new Date(),
    user: userInput.value || "未入力",
    type: "入庫",
    name,
    qty
  });

  loadAll();
}

async function ship(name) {
  const { data } = await supabase.from("stocks").select("*").eq("name", name).single();
  if (!data) return;

  const newQty = data.qty - 1;
  if (newQty <= 0) {
    await supabase.from("stocks").delete().eq("id", data.id);
  } else {
    await supabase.from("stocks").update({ qty: newQty }).eq("id", data.id);
  }

  await supabase.from("history").insert({
    date: new Date(),
    user: userInput.value || "未入力",
    type: "出庫",
    name,
    qty: 1
  });

  loadAll();
}

function renderStocks(stocks) {
  stockTable.innerHTML = `<tr><th>商品</th><th>数量</th><th>操作</th></tr>`;
  stocks.forEach(s => {
    const tr = stockTable.insertRow();
    if (s.qty <= ALERT_QTY) tr.className = "low";
    tr.innerHTML = `
      <td>${s.name}</td>
      <td>${s.qty}</td>
      <td><button onclick="ship('${s.name}')">出庫</button></td>`;
  });
}

function renderHistory(history) {
  historyTable.innerHTML = `<tr><th>日時</th><th>ユーザー</th><th>種別</th><th>商品</th><th>数量</th></tr>`;
  history.forEach(h => {
    historyTable.insertRow().innerHTML =
      `<td>${h.date}</td><td>${h.user}</td><td>${h.type}</td><td>${h.name}</td><td>${h.qty}</td>`;
  });
}

loadAll();
</script>

</body>
</html>
