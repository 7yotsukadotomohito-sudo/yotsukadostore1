<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body { font-family: sans-serif; padding: 30px; }
input, button { padding: 6px; margin: 4px; }
table { border-collapse: collapse; margin-bottom: 30px; width: 900px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #f0f0f0; }
.low { background: #ffe5e5; color: #c00; font-weight: bold; }
#status { padding: 10px; margin: 10px 0; border: 1px solid #ddd; background:#fafafa; }
.bad { border-color:#f99; background:#fff0f0; }
.good { border-color:#9f9; background:#f0fff0; }
.hidden { display:none; }
.box { border:1px solid #ddd; padding:12px; margin:10px 0; }
</style>
</head>

<body>
<h1>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

<div id="status">çŠ¶æ…‹: èµ·å‹•ä¸­â€¦</div>

<!-- ãƒ­ã‚°ã‚¤ãƒ³UI -->
<div id="authBox" class="box">
  <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <div>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š</div>
  <input id="emailInput" type="email" placeholder="you@example.com" style="width:320px;">
  <button onclick="sendMagicLink()">ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ã‚‹ï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰</button>
  <p style="margin:8px 0 0 0; font-size: 14px;">
    â€»ãƒ¡ãƒ¼ãƒ«ã«å±Šããƒªãƒ³ã‚¯ã‚’æŠ¼ã™ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦ï¼‰
  </p>
</div>

<div id="appBox" class="hidden">

  <div class="box">
    ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š<span id="userLabel">-</span>
    <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <h2>å…¥åº«</h2>
  <input id="nameInput" placeholder="å•†å“å">
  <input id="qtyInput" type="number" placeholder="æ•°é‡">
  <button onclick="addItem()">å…¥åº«</button>

  <h2>åœ¨åº«ä¸€è¦§</h2>
  <table id="stockTable"></table>

  <h2>å…¥å‡ºåº«å±¥æ­´</h2>
  <table id="historyTable"></table>
</div>

<script>
/* =========================
   ğŸ”‘ Supabase æ¥ç¶šï¼ˆã‚ãªãŸã®æƒ…å ±ã‚’åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ï¼‰
   ========================= */
const SUPABASE_URL = "https://dabhwrkugxxbkvwlcyxi.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhYmh3cmt1Z3h4Ymt2d2xjeXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjAwNjksImV4cCI6MjA4Mjg5NjA2OX0.G60_QQy0SOY7w-72Mq-gMoq99kUPj1I6c13G2SxOHeQ";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const ALERT_QTY = 3;

function setStatus(msg, ok=true) {
  const el = document.getElementById("status");
  el.textContent = "çŠ¶æ…‹: " + msg;
  el.className = ok ? "good" : "bad";
}
function showErr(context, err) {
  console.error(context, err);
  const detail = err ? (err.message || JSON.stringify(err)) : "unknown";
  alert(`${context}\n\n${detail}`);
  setStatus(`${context} â†’ ${detail}`, false);
}

/* =========================
   Authï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼‰
   ========================= */
async function sendMagicLink() {
  const email = emailInput.value.trim();
  if (!email) return alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ã­");

  setStatus("ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯é€ä¿¡ä¸­â€¦");
  const { error } = await supabaseClient.auth.signInWithOtp({
    email,
    options: {
      // Vercelã®URLã«åˆã‚ã›ã‚‹ï¼ˆã‚ãªãŸã®URLï¼‰
      emailRedirectTo: "https://yotsukadostore1.vercel.app/"
    }
  });
  if (error) return showErr("ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯é€ä¿¡å¤±æ•—", error);

  setStatus("ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã€å±Šã„ãŸãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ãã ã•ã„", true);
  alert("ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã€å±Šã„ãŸãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ãã ã•ã„ï¼");
}

async function logout() {
  await supabaseClient.auth.signOut();
  setStatus("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ", true);
  renderAuthUI(null);
}

function renderAuthUI(session) {
  const authed = !!session?.user;
  document.getElementById("authBox").classList.toggle("hidden", authed);
  document.getElementById("appBox").classList.toggle("hidden", !authed);
  document.getElementById("userLabel").textContent = authed ? (session.user.email || "ãƒ­ã‚°ã‚¤ãƒ³ä¸­") : "-";
}

/* =========================
   ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆstocks/historyï¼‰
   RLS: authenticated ã ã‘è¨±å¯ã•ã‚Œã‚‹å‰æ
   ========================= */
async function loadAll() {
  setStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
  const s = await supabaseClient.from("stocks").select("*").order("name");
  if (s.error) return showErr("stocks èª­ã¿è¾¼ã¿å¤±æ•—", s.error);

  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("history èª­ã¿è¾¼ã¿å¤±æ•—", h.error);

  renderStocks(s.data || []);
  renderHistory(h.data || []);
  setStatus("èª­ã¿è¾¼ã¿å®Œäº†", true);
}

async function addItem() {
  const name = nameInput.value.trim();
  const qty = Number(qtyInput.value);
  if (!name || !qty) return alert("å•†å“åã¨æ•°é‡ã‚’å…¥åŠ›ã—ã¦ã­");

  const { data: sessionData } = await supabaseClient.auth.getSession();
  const email = sessionData?.session?.user?.email || "unknown";

  // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks æ—¢å­˜ãƒã‚§ãƒƒã‚¯å¤±æ•—", ex.error);

  if (ex.data) {
    const up = await supabaseClient.from("stocks").update({ qty: ex.data.qty + qty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update å¤±æ•—", up.error);
  } else {
    const ins = await supabaseClient.from("stocks").insert({ name, qty });
    if (ins.error) return showErr("stocks insert å¤±æ•—", ins.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: email,
    type: "å…¥åº«",
    name,
    qty
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  nameInput.value = "";
  qtyInput.value = "";
  await loadAll();
}

async function shipItem(name) {
  const { data: sessionData } = await supabaseClient.auth.getSession();
  const email = sessionData?.session?.user?.email || "unknown";

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks å–å¾—å¤±æ•—", ex.error);
  if (!ex.data) return;

  const newQty = ex.data.qty - 1;
  if (newQty <= 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete å¤±æ•—", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update å¤±æ•—", up.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: email,
    type: "å‡ºåº«",
    name,
    qty: 1
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  await loadAll();
}

function renderStocks(stocks) {
  stockTable.innerHTML = "<tr><th>å•†å“</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr>";
  stocks.forEach(s => {
    const tr = stockTable.insertRow();
    if (Number(s.qty) <= ALERT_QTY) tr.className = "low";
    tr.innerHTML = `
      <td>${s.name}</td>
      <td>${s.qty}</td>
      <td><button onclick="shipItem('${s.name}')">å‡ºåº«</button></td>
    `;
  });
}

function renderHistory(history) {
  historyTable.innerHTML = "<tr><th>æ—¥æ™‚</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>ç¨®åˆ¥</th><th>å•†å“</th><th>æ•°é‡</th></tr>";
  history.forEach(h => {
    const tr = historyTable.insertRow();
    tr.innerHTML = `<td>${h.date}</td><td>${h.user}</td><td>${h.type}</td><td>${h.name}</td><td>${h.qty}</td>`;
  });
}

/* =========================
   èµ·å‹•ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–ã—ã¦è¡¨ç¤ºã‚’åˆ‡æ›¿
   ========================= */
(async () => {
  setStatus("ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªä¸­â€¦");

  const { data: sessionData, error } = await supabaseClient.auth.getSession();
  if (error) return showErr("ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—å¤±æ•—", error);

  renderAuthUI(sessionData.session);

  supabaseClient.auth.onAuthStateChange(async (_event, session) => {
    renderAuthUI(session);
    if (session) {
      setStatus("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€‚ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­â€¦", true);
      await loadAll();
    }
  });

  if (sessionData.session) {
    setStatus("ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã€‚ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­â€¦", true);
    await loadAll();
  } else {
    setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã€‚ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„", true);
  }
})();
</script>

</body>
</html>
