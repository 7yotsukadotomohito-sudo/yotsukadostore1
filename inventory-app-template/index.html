<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>在庫管理システム</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;

    --primary:#2563eb;
    --primaryHover:#1d4ed8;
    --danger:#dc2626;
    --dangerHover:#b91c1c;
    --ghost:#e5e7eb;
    --ghostHover:#d1d5db;

    --goodBg:#ecfdf5;
    --goodLine:#86efac;
    --badBg:#fff1f2;
    --badLine:#fca5a5;

    --lowBg:#fff1f2;
    --lowText:#9f1239;

    --radius:14px;
    --shadow:0 8px 24px rgba(17,24,39,.08);
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--text);
    background:var(--bg);
  }

  a{ color:var(--primary); }
  code{
    background:#f3f4f6;
    padding:2px 6px;
    border-radius:8px;
    font-size: 12px;
  }

  .container{
    max-width: 1080px;
    margin: 0 auto;
    padding: 18px;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    margin-bottom: 14px;
  }

  .title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  h1{
    font-size: 22px;
    margin:0;
    letter-spacing: .02em;
  }
  .subtitle{
    color: var(--muted);
    font-size: 13px;
  }

  .topActions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 14px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  @media (max-width: 900px){
    .grid{ grid-template-columns: 1fr; }
  }

  .sectionTitle{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 8px;
    margin: 0 0 10px 0;
  }
  .sectionTitle h2{
    margin:0;
    font-size: 16px;
  }
  .hint{
    color:var(--muted);
    font-size: 12px;
  }

  /* Status */
  #status{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: #fff;
    margin-bottom: 12px;
    font-size: 13px;
  }
  #status.good{
    background: var(--goodBg);
    border-color: var(--goodLine);
  }
  #status.bad{
    background: var(--badBg);
    border-color: var(--badLine);
  }

  /* Form */
  .row{
    display:flex;
    gap: 10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width: 180px;
    flex: 1;
  }
  .field label{
    font-size: 12px;
    color: var(--muted);
  }

  input[type="text"], input[type="password"], input[type="number"]{
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border:1px solid var(--line);
    outline: none;
    background:#fff;
    font-size: 14px;
  }
  input:focus{
    border-color: rgba(37,99,235,.55);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }

  input[type="file"]{
    padding: 10px 0;
  }

  /* Buttons */
  button{
    border: none;
    border-radius: 12px;
    padding: 10px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: transform .02s ease, background .15s ease, opacity .15s ease;
    user-select:none;
    white-space:nowrap;
  }
  button:active{ transform: translateY(1px); }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  .btn-primary{ background: var(--primary); color: #fff; }
  .btn-primary:hover{ background: var(--primaryHover); }

  .btn-danger{ background: var(--danger); color: #fff; }
  .btn-danger:hover{ background: var(--dangerHover); }

  .btn-ghost{ background: var(--ghost); color: var(--text); }
  .btn-ghost:hover{ background: var(--ghostHover); }

  .btn-small{
    padding: 7px 10px;
    border-radius: 10px;
    font-size: 13px;
  }

  /* Tables */
  .tableCard{ padding: 0; overflow: hidden; }
  .tableHeader{
    padding: 12px 14px;
    border-bottom: 1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .tableHeader h2{
    margin:0;
    font-size: 16px;
  }
  .tableWrap{
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  table{
    width: 100%;
    border-collapse: collapse;
    min-width: 760px;
    background: #fff;
  }
  th, td{
    padding: 12px 12px;
    border-bottom: 1px solid #f0f1f4;
    text-align: left;
    font-size: 14px;
  }
  th{
    background: #fafafa;
    color:#374151;
    font-weight: 700;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  td.qty{
    text-align: right;
    font-variant-numeric: tabular-nums;
    font-weight: 700;
  }
  td.center{ text-align:center; }
  .muted{ color:var(--muted); font-size: 12px; }
  tr.low-stock td{
    background: var(--lowBg);
    color: var(--lowText);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap: 6px;
    padding: 6px 10px;
    border: 1px solid var(--line);
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
    background:#fff;
  }

  /* Mobile helpers */
  @media (max-width: 600px){
    .topActions{
      width:100%;
      justify-content:flex-start;
    }
    .row.actions{
      flex-direction: column;
      align-items: stretch;
    }
    .row.actions button{
      width: 100%;
    }
    table{
      min-width: 920px; /* 横スクロール前提 */
    }
  }
</style>
</head>

<body>
<div class="container">

  <header>
    <div class="title">
      <h1>在庫管理システム</h1>
      <div class="subtitle">UI v2（反映確認用） / URLで即利用 / 編集はPINで制御（ログインなし）</div>
    </div>

    <div class="topActions">
      <button class="btn-ghost" onclick="loadAll()">最新に更新</button>
      <span class="pill">少数アラート: <b id="alertBadge">3</b> 以下</span>
    </div>
  </header>

  <div id="status" class="good">状態: 起動中…</div>

  <div class="grid">
    <div class="card">
      <div class="sectionTitle">
        <h2>編集PIN</h2>
        <div class="hint">※PINはブラウザに記憶されます</div>
      </div>
      <div class="row">
        <div class="field" style="max-width:260px;">
          <label>PIN（操作する人だけ入力）</label>
          <input id="pinInput" type="password" placeholder="PIN" />
        </div>
        <button class="btn-ghost" onclick="clearSavedPin()">PINを忘れる</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        閲覧は誰でもOK / 編集はPIN入力が必要
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">
        <h2>ユーザー名（履歴用）</h2>
        <div class="hint">※未入力でもOK</div>
      </div>
      <div class="row">
        <div class="field" style="max-width:260px;">
          <label>履歴に残す名前</label>
          <input id="userInput" placeholder="例：山田" />
        </div>
      </div>
      <div class="muted" style="margin-top:10px;">
        「誰が操作したか」を残したいときに入力
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <div class="sectionTitle">
        <h2>入庫（手入力）</h2>
        <div class="hint">商品名必須 / SKUは任意</div>
      </div>

      <div class="row actions">
        <div class="field">
          <label>SKU（任意）</label>
          <input id="skuInput" placeholder="SKU（任意）" />
        </div>
        <div class="field">
          <label>商品名（必須）</label>
          <input id="nameInput" placeholder="商品名（必須）" />
        </div>
        <div class="field" style="max-width:160px;">
          <label>数量</label>
          <input id="qtyInput" type="number" placeholder="数量" />
        </div>
        <button class="btn-primary" onclick="addItemManual()">入庫</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">
        <h2>CSV（ブラウザでアップロード）</h2>
        <div class="hint">SKU or 商品名で照合 / 増減 & 上書き</div>
      </div>

      <div class="row actions" style="margin-bottom:10px;">
        <button class="btn-ghost" onclick="exportStocksCSV()">在庫CSVエクスポート（バックアップ）</button>
        <button class="btn-ghost" onclick="exportHistoryCSV()">履歴CSVエクスポート（バックアップ）</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="font-weight:700;">在庫CSVインポート</div>
        <input type="file" accept=".csv,text/csv" onchange="importStocksCSV(this)" />
      </div>

      <div class="muted" style="margin-top:8px; line-height:1.55;">
        形式A（増減）：<code>sku,name,delta</code>（deltaは +/−）<br>
        形式B（上書き）：<code>sku,name,qty</code><br>
        ※skuが空ならnameで照合。qty=0は削除扱い。
      </div>
    </div>
  </div>

  <!-- 在庫一覧 -->
  <div class="card tableCard" style="margin-top:12px;">
    <div class="tableHeader">
      <h2>在庫一覧</h2>
      <div class="hint">少数在庫はハイライト（≤ <span id="alertLabel">3</span>）</div>
    </div>
    <div class="tableWrap">
      <table id="stockTable"></table>
    </div>
  </div>

  <!-- 月次出庫集計 -->
  <div class="card tableCard" style="margin-top:12px;">
    <div class="tableHeader">
      <h2>月次出庫集計</h2>
      <div class="hint">history の「出庫」から算出</div>
    </div>
    <div class="tableWrap">
      <table id="monthlyTable"></table>
    </div>
  </div>

  <!-- 入出庫履歴 -->
  <div class="card tableCard" style="margin-top:12px; margin-bottom:18px;">
    <div class="tableHeader">
      <h2>入出庫履歴</h2>
      <div class="hint">東京時間（JST）で表示 / 最新が上</div>
    </div>
    <div class="tableWrap">
      <table id="historyTable"></table>
    </div>
  </div>

</div>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL = "https://dabhwrkugxxbkvwlcyxi.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhYmh3cmt1Z3h4Ymt2d2xjeXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjAwNjksImV4cCI6MjA4Mjg5NjA2OX0.G60_QQy0SOY7w-72Mq-gMoq99kUPj1I6c13G2SxOHeQ";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ✅ 運用PIN（空文字ならPINなし） */
const EDIT_PIN = "1234";

/* アラート閾値 */
const ALERT_QTY = 3;

/* ========= UI helpers ========= */
function setStatus(msg, ok=true) {
  const el = document.getElementById("status");
  el.textContent = "状態: " + msg;
  el.className = ok ? "good" : "bad";
}
function showErr(context, err) {
  console.error(context, err);
  const detail = err ? (err.message || JSON.stringify(err)) : "unknown";
  alert(`${context}\n\n${detail}`);
  setStatus(`${context} → ${detail}`, false);
}
function currentUser() {
  return (document.getElementById("userInput").value || "未入力").trim() || "未入力";
}

/* ========= PIN 記憶 ========= */
function loadSavedPin() {
  const saved = localStorage.getItem("inv_pin") || "";
  document.getElementById("pinInput").value = saved;
}
function savePinOnChange() {
  const el = document.getElementById("pinInput");
  el.addEventListener("input", () => localStorage.setItem("inv_pin", el.value));
}
function clearSavedPin(){
  localStorage.removeItem("inv_pin");
  document.getElementById("pinInput").value = "";
  setStatus("PINをクリアしました（閲覧のみ）", true);
}
function checkPin() {
  if (!EDIT_PIN) return true;
  const entered = (document.getElementById("pinInput").value || "").trim();
  if (entered !== EDIT_PIN) {
    alert("PINが違います（操作できません）");
    return false;
  }
  return true;
}

/* ========= Load & Render ========= */
window.onload = async () => {
  document.getElementById("alertBadge").textContent = String(ALERT_QTY);
  document.getElementById("alertLabel").textContent = String(ALERT_QTY);

  loadSavedPin();
  savePinOnChange();
  setStatus("読み込み中…");
  await loadAll();
};

async function loadAll() {
  setStatus("読み込み中…");
  const s = await supabaseClient.from("stocks").select("*").order("name");
  if (s.error) return showErr("stocks 読み込み失敗", s.error);

  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("history 読み込み失敗", h.error);

  renderStocks(s.data || []);
  renderHistory(h.data || []);
  renderMonthly(h.data || []);
  setStatus("準備OK", true);
}

function renderStocks(stocks) {
  const table = document.getElementById("stockTable");
  table.innerHTML = `
    <tr>
      <th style="width:160px;">SKU</th>
      <th>商品</th>
      <th style="width:120px; text-align:right;">数量</th>
      <th style="width:380px;">操作</th>
    </tr>`;

  if (!stocks.length){
    const tr = table.insertRow();
    tr.innerHTML = `<td colspan="4" class="center muted">まだ在庫がありません</td>`;
    return;
  }

  stocks.forEach(s => {
    const qty = Number(s.qty || 0);
    const tr = table.insertRow();
    if (qty <= ALERT_QTY) tr.classList.add("low-stock");

    tr.innerHTML = `
      <td class="muted">${escapeHtml(s.sku || "-")}</td>
      <td>${escapeHtml(s.name)}</td>
      <td class="qty">${qty}</td>
      <td>
        <button class="btn-primary btn-small" onclick="shipItem('${escapeJs(s.sku||"")}', '${escapeJs(s.name)}')">出庫(-1)</button>
        <button class="btn-ghost btn-small" onclick="shipItemQty('${escapeJs(s.sku||"")}', '${escapeJs(s.name)}')">数量出庫</button>
        <button class="btn-ghost btn-small" onclick="editQty('${escapeJs(s.sku||"")}', '${escapeJs(s.name)}', ${qty})">編集</button>
        <button class="btn-danger btn-small" onclick="deleteItem('${escapeJs(s.sku||"")}', '${escapeJs(s.name)}')">削除</button>
      </td>
    `;
  });
}

function renderHistory(history) {
  const table = document.getElementById("historyTable");
  table.innerHTML = `
    <tr>
      <th style="width:190px;">日時（JST）</th>
      <th style="width:120px;">ユーザー</th>
      <th style="width:120px;">種別</th>
      <th style="width:160px;">SKU</th>
      <th>商品</th>
      <th style="width:110px; text-align:right;">数量</th>
    </tr>`;

  if (!history.length){
    const tr = table.insertRow();
    tr.innerHTML = `<td colspan="6" class="center muted">まだ履歴がありません</td>`;
    return;
  }

  history.forEach(h => {
    const tr = table.insertRow();
    tr.innerHTML = `
      <td class="muted">${escapeHtml(formatDate(h.date))}</td>
      <td>${escapeHtml(h.user)}</td>
      <td>${escapeHtml(h.type)}</td>
      <td class="muted">${escapeHtml(h.sku || "-")}</td>
      <td>${escapeHtml(h.name)}</td>
      <td class="qty">${escapeHtml(String(h.qty))}</td>
    `;
  });
}

/* ========= 月次出庫 ========= */
function renderMonthly(history) {
  const table = document.getElementById("monthlyTable");
  const map = {};
  history.filter(h => h.type === "出庫").forEach(h => {
    const ym = String(h.date).slice(0,7);
    map[ym] = (map[ym] || 0) + Number(h.qty || 0);
  });

  table.innerHTML = `
    <tr>
      <th style="width:160px;">月</th>
      <th style="width:140px; text-align:right;">出庫数</th>
    </tr>`;

  const keys = Object.keys(map).sort();
  if (!keys.length) {
    table.insertRow().innerHTML = `<td colspan="2" class="center muted">まだ出庫履歴がありません</td>`;
    return;
  }
  keys.forEach(ym => {
    const tr = table.insertRow();
    tr.innerHTML = `<td>${escapeHtml(ym)}</td><td class="qty">${map[ym]}</td>`;
  });
}

/* ========= 照合：SKU優先、なければ商品名 ========= */
async function findStockRow(sku, name) {
  if (sku) {
    const r = await supabaseClient.from("stocks").select("*").eq("sku", sku).maybeSingle();
    return r;
  } else {
    const r = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
    return r;
  }
}

/* ========= 手入力入庫 ========= */
async function addItemManual() {
  if (!checkPin()) return;

  const sku = (document.getElementById("skuInput").value || "").trim();
  const name = (document.getElementById("nameInput").value || "").trim();
  const qty = Number(document.getElementById("qtyInput").value);

  if (!name || !qty) return alert("商品名と数量を入力してください");

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 既存チェック失敗", ex.error);

  if (ex.data) {
    const up = await supabaseClient.from("stocks").update({ qty: Number(ex.data.qty) + qty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update 失敗", up.error);
  } else {
    const ins = await supabaseClient.from("stocks").insert({ sku: sku || null, name, qty });
    if (ins.error) return showErr("stocks insert 失敗", ins.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "入庫",
    sku: sku || null,
    name,
    qty
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  document.getElementById("skuInput").value = "";
  document.getElementById("nameInput").value = "";
  document.getElementById("qtyInput").value = "";

  await loadAll();
}

/* ========= 出庫（-1）/ 数量出庫 / 編集 / 削除 ========= */
async function shipItem(sku, name) {
  if (!checkPin()) return;

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return;

  const newQty = Number(ex.data.qty) - 1;

  if (newQty <= 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete 失敗", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update 失敗", up.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "出庫",
    sku: ex.data.sku || null,
    name: ex.data.name,
    qty: 1
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

// 数量出庫（追加ボタン）
async function shipItemQty(sku, name) {
  if (!checkPin()) return;

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return;

  const current = Number(ex.data.qty || 0);

  const input = prompt(
    `数量出庫（SKU: ${sku||"-"} / 商品: ${ex.data.name}）\n現在: ${current}\n出庫数量（1以上）`,
    "1"
  );
  if (input === null) return;

  const n = Number(input);
  if (!Number.isFinite(n) || n <= 0) return alert("1以上の数字を入力してください");

  const newQty = current - n;

  if (newQty <= 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete 失敗", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update 失敗", up.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "出庫",
    sku: ex.data.sku || null,
    name: ex.data.name,
    qty: n
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

async function editQty(sku, name, currentQty) {
  if (!checkPin()) return;

  const input = prompt(`在庫数を変更（SKU: ${sku||"-"} / 商品: ${name}）\n現在: ${currentQty}\n新しい数量`, String(currentQty));
  if (input === null) return;

  const newQty = Number(input);
  if (!Number.isFinite(newQty) || newQty < 0) return alert("0以上の数字を入力してください");

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return alert("商品が見つかりません");

  if (newQty === 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete 失敗", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update 失敗", up.error);
  }

  const diff = newQty - Number(ex.data.qty);
  const type = diff >= 0 ? "編集（増）" : "編集（減）";

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type,
    sku: ex.data.sku || null,
    name: ex.data.name,
    qty: Math.abs(diff)
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

async function deleteItem(sku, name) {
  if (!checkPin()) return;
  if (!confirm(`「${name}」を削除します。OK？`)) return;

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return;

  const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
  if (del.error) return showErr("stocks delete 失敗", del.error);

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "削除",
    sku: ex.data.sku || null,
    name: ex.data.name,
    qty: 0
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

/* ========= CSV Export ========= */
function downloadText(filename, text) {
  const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
}
function csvEscape(v) {
  const s = String(v ?? "");
  if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

async function exportStocksCSV() {
  const s = await supabaseClient.from("stocks").select("*").order("name");
  if (s.error) return showErr("在庫CSV取得失敗", s.error);

  let csv = "sku,name,qty\n";
  (s.data || []).forEach(r => { csv += `${csvEscape(r.sku||"")},${csvEscape(r.name)},${Number(r.qty)}\n`; });
  downloadText(`stocks_${todayStr()}.csv`, csv);
}
async function exportHistoryCSV() {
  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("履歴CSV取得失敗", h.error);

  let csv = "date,user,type,sku,name,qty\n";
  (h.data || []).forEach(r => {
    csv += `${csvEscape(r.date)},${csvEscape(r.user)},${csvEscape(r.type)},${csvEscape(r.sku||"")},${csvEscape(r.name)},${csvEscape(String(r.qty))}\n`;
  });
  downloadText(`history_${todayStr()}.csv`, csv);
}

/* ========= CSV Import（SKU or Name / delta or qty） + レポート ========= */
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  for (let i=0; i<text.length; i++) {
    const ch = text[i], next = text[i+1];
    if (ch === '"') {
      if (inQ && next === '"') { cur += '"'; i++; }
      else inQ = !inQ;
      continue;
    }
    if (!inQ && ch === ",") { row.push(cur); cur=""; continue; }
    if (!inQ && (ch === "\n" || ch === "\r")) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur); rows.push(row);
      row=[]; cur=""; continue;
    }
    cur += ch;
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

async function importStocksCSV(inputEl) {
  if (!checkPin()) { inputEl.value = ""; return; }
  const file = inputEl.files?.[0];
  if (!file) return;

  setStatus("CSV読み込み中…", true);

  const text = await file.text();
  const rows = parseCSV(text).map(r => r.map(c => (c ?? "").trim())).filter(r => r.length >= 2);
  if (!rows.length) {
    alert("CSVが空です");
    inputEl.value = "";
    return;
  }

  // ===== レポート集計 =====
  let countProcessed = 0;
  let countUpdated = 0;
  let countInserted = 0;
  let countDeleted = 0;
  let countSkipped = 0;
  const errors = [];
  const pushError = (line, msg) => errors.push(`行${line}: ${msg}`);

  // ヘッダー判定（sku,name,delta or sku,name,qty or name,qty）
  const header = rows[0].map(x => x.toLowerCase());
  const hasHeader = header.includes("name") || header.includes("sku") || header.includes("qty") || header.includes("delta");

  let dataRows = rows;
  let mode = "set"; // set=qty上書き / delta=増減
  let idxSku = 0, idxName = 1, idxValue = 2;

  if (hasHeader) {
    idxSku = header.indexOf("sku");
    idxName = header.indexOf("name");
    const iDelta = header.indexOf("delta");
    const iQty = header.indexOf("qty");
    if (iDelta !== -1) { mode="delta"; idxValue = iDelta; }
    else { mode="set"; idxValue = iQty !== -1 ? iQty : 2; }
    dataRows = rows.slice(1);
  } else {
    mode = "set";
    if (rows[0].length === 2) { idxSku = -1; idxName = 0; idxValue = 1; }
    else { idxSku = 0; idxName = 1; idxValue = 2; }
  }

  // 既存をまとめて取得してMap化（速度用）
  const existing = await supabaseClient.from("stocks").select("*");
  if (existing.error) return showErr("既存在庫取得失敗", existing.error);

  const bySku = new Map((existing.data||[]).filter(x=>x.sku).map(x => [x.sku, x]));
  const byName = new Map((existing.data||[]).map(x => [x.name, x]));

  setStatus("CSV取り込み中…", true);

  for (let i = 0; i < dataRows.length; i++) {
    const r = dataRows[i];
    const lineNo = hasHeader ? (i + 2) : (i + 1); // CSV上の行番号目安

    try{
      const sku = idxSku >= 0 ? (r[idxSku] || "").trim() : "";
      const name = (r[idxName] || "").trim();
      const valRaw = (r[idxValue] || "").trim();
      if (!name && !sku) { countSkipped++; continue; }

      const num = Number(valRaw);
      if (!Number.isFinite(num)) {
        countSkipped++;
        pushError(lineNo, `数量が数値ではありません（"${valRaw}"）`);
        continue;
      }

      const found = sku ? bySku.get(sku) : byName.get(name);

      if (!found) {
        // 無ければ新規
        const startQty = num; // deltaでもsetでも、初回はnum
        if (startQty <= 0) { countSkipped++; continue; }

        const ins = await supabaseClient.from("stocks").insert({ sku: sku || null, name: name || "(no name)", qty: startQty });
        if (ins.error) { pushError(lineNo, `insert失敗（${sku||name}）: ${ins.error.message}`); continue; }

        countInserted++; countProcessed++;

        const hin = await supabaseClient.from("history").insert({
          date: new Date().toISOString(),
          user: currentUser(),
          type: mode === "delta" ? "CSV増減" : "CSV上書き",
          sku: sku || null,
          name: name || "(no name)",
          qty: Math.abs(startQty)
        });
        if (hin.error) pushError(lineNo, `history失敗: ${hin.error.message}`);
        continue;
      }

      // 既存あり：更新
      let newQty;
      if (mode === "delta") newQty = Number(found.qty) + num;
      else newQty = num;

      if (newQty <= 0) {
        const del = await supabaseClient.from("stocks").delete().eq("id", found.id);
        if (del.error) { pushError(lineNo, `delete失敗（${found.sku||found.name}）: ${del.error.message}`); continue; }

        countDeleted++; countProcessed++;

        // map更新
        if (found.sku) bySku.delete(found.sku);
        byName.delete(found.name);
      } else {
        const up = await supabaseClient.from("stocks").update({ qty: newQty, sku: sku || found.sku || null, name: name || found.name }).eq("id", found.id);
        if (up.error) { pushError(lineNo, `update失敗（${found.sku||found.name}）: ${up.error.message}`); continue; }

        countUpdated++; countProcessed++;

        // map更新
        const updated = { ...found, qty: newQty, sku: (sku || found.sku || null), name: (name || found.name) };
        if (found.sku && updated.sku !== found.sku) bySku.delete(found.sku);
        if (updated.sku) bySku.set(updated.sku, updated);
        byName.delete(found.name);
        byName.set(updated.name, updated);
      }

      const hin = await supabaseClient.from("history").insert({
        date: new Date().toISOString(),
        user: currentUser(),
        type: mode === "delta" ? "CSV増減" : "CSV上書き",
        sku: (sku || found.sku || null),
        name: (name || found.name),
        qty: Math.abs(num)
      });
      if (hin.error) pushError(lineNo, `history失敗: ${hin.error.message}`);

    }catch(e){
      countSkipped++;
      pushError(lineNo, `例外: ${e?.message || String(e)}`);
    }
  }

  inputEl.value = "";
  await loadAll();

  const summary =
`CSVインポート完了
処理: ${countProcessed}件（insert:${countInserted} / update:${countUpdated} / delete:${countDeleted}）
スキップ: ${countSkipped}件
エラー: ${errors.length}件`;

  if (errors.length) {
    const head = errors.slice(0, 20).join("\n");
    alert(summary + "\n\n--- エラー詳細（最大20件表示） ---\n" + head + (errors.length > 20 ? `\n…他 ${errors.length - 20} 件` : ""));
    setStatus(`CSV完了（エラー ${errors.length}件）`, false);
  } else {
    alert(summary);
    setStatus("CSV完了（エラーなし）", true);
  }
}

/* ========= 日時: 東京時間（JST）で表示 ========= */
function formatDate(iso){
  try{
    const d = new Date(iso);
    if (isNaN(d.getTime())) return String(iso);

    const parts = new Intl.DateTimeFormat("ja-JP", {
      timeZone: "Asia/Tokyo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    }).formatToParts(d);

    const get = (type) => parts.find(p => p.type === type)?.value || "";
    return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}:${get("second")}`;
  }catch(e){
    return String(iso);
  }
}

/* ========= escaping ========= */
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
function escapeJs(s) {
  return String(s ?? "").replaceAll("\\","\\\\").replaceAll("'","\\'").replaceAll("\n"," ").replaceAll("\r"," ");
}
</script>

</body>
</html>
