<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body { font-family: sans-serif; padding: 30px; }
  input, button { padding: 6px; margin: 4px; }
  table { border-collapse: collapse; margin-bottom: 20px; width: 980px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  .low { background: #ffe5e5; color: #c00; font-weight: bold; }
  #status { padding: 10px; margin: 10px 0; border: 1px solid #ddd; background:#fafafa; }
  .bad { border-color:#f99; background:#fff0f0; }
  .good { border-color:#9f9; background:#f0fff0; }
  .box { border:1px solid #ddd; padding:12px; margin:10px 0; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .small { font-size: 13px; color:#666; }
</style>
</head>

<body>
<h1>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

<div id="status">çŠ¶æ…‹: èµ·å‹•ä¸­â€¦</div>

<div class="box">
  <div class="row">
    <div><b>ç·¨é›†PIN</b>ï¼ˆæ“ä½œã™ã‚‹äººã ã‘å…¥åŠ›ï¼‰</div>
    <input id="pinInput" type="password" placeholder="PIN">
    <span class="small">â€»PINã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«è¨˜æ†¶ã•ã‚Œã¾ã™</span>
  </div>
</div>

<div class="box">
  <div class="row">
    <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆå±¥æ­´ç”¨ï¼‰ï¼š</div>
    <input id="userInput" placeholder="ä¾‹ï¼šå±±ç”°">
    <span class="small">â€»æœªå…¥åŠ›ã§ã‚‚OK</span>
  </div>
</div>

<div class="box">
  <h2 style="margin:0 0 8px 0;">å…¥åº«</h2>
  <div class="row">
    <input id="nameInput" placeholder="å•†å“å">
    <input id="qtyInput" type="number" placeholder="æ•°é‡">
    <button onclick="addItem()">å…¥åº«</button>
  </div>
</div>

<div class="box">
  <h2 style="margin:0 0 8px 0;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆç°¡å˜ãƒ«ãƒ¼ãƒˆï¼‰</h2>
  <div class="row">
    <button onclick="exportStocksCSV()">åœ¨åº«CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button onclick="exportHistoryCSV()">å±¥æ­´CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  </div>
  <div class="small">
    âœ…ãŠã™ã™ã‚é‹ç”¨ï¼šé€±1å›ï¼ˆã¾ãŸã¯æœˆæœ«ï¼‰ã«ã“ã®2ã¤ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿ç®¡ï¼ˆGoogle Driveãªã©ï¼‰
  </div>
</div>

<div class="box">
  <h2 style="margin:0 0 8px 0;">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</h2>

  <div class="row">
    <b>åœ¨åº«CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</b>
    <input type="file" accept=".csv,text/csv" onchange="importStocksCSV(this)">
  </div>
  <div class="small">
    å½¢å¼ï¼š<code>name,qty</code>ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚ã£ã¦OKï¼‰
  </div>

  <div class="row" style="margin-top:10px;">
    <b>å±¥æ­´CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</b>
    <input type="file" accept=".csv,text/csv" onchange="importHistoryCSV(this)">
  </div>
  <div class="small">
    å½¢å¼ï¼š<code>date,user,type,name,qty</code>ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚ã£ã¦OKï¼‰<br>
    dateã¯ <code>2026-01-02T06:00:00.000Z</code> ã¿ãŸã„ãªå½¢ãŒå®‰å…¨
  </div>
</div>

<h2>åœ¨åº«ä¸€è¦§</h2>
<table id="stockTable"></table>

<h2>æœˆæ¬¡å‡ºåº«é›†è¨ˆï¼ˆBï¼‰</h2>
<table id="monthlyTable"></table>

<h2>å…¥å‡ºåº«å±¥æ­´</h2>
<table id="historyTable"></table>

<script>
/* =========================
   ğŸ”‘ Supabase æ¥ç¶šï¼ˆåŠ å·¥ãªã—ï¼ç¢ºå®šï¼‰
   ========================= */
const SUPABASE_URL = "https://dabhwrkugxxbkvwlcyxi.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhYmh3cmt1Z3h4Ymt2d2xjeXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjAwNjksImV4cCI6MjA4Mjg5NjA2OX0.G60_QQy0SOY7w-72Mq-gMoq99kUPj1I6c13G2SxOHeQ";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* âœ… ã“ã“ã‚’å¥½ããªPINã«å¤‰æ›´ï¼ˆä¾‹ "7391"ï¼‰ã€‚ç©ºæ–‡å­— "" ã«ã™ã‚‹ã¨PINãªã—é‹ç”¨ */
const EDIT_PIN = "1234";

/* ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ */
const ALERT_QTY = 3;

/* =========================
   UI helpers
   ========================= */
function setStatus(msg, ok=true) {
  const el = document.getElementById("status");
  el.textContent = "çŠ¶æ…‹: " + msg;
  el.className = ok ? "good" : "bad";
}
function showErr(context, err) {
  console.error(context, err);
  const detail = err ? (err.message || JSON.stringify(err)) : "unknown";
  alert(`${context}\n\n${detail}`);
  setStatus(`${context} â†’ ${detail}`, false);
}
function currentUser() {
  return (document.getElementById("userInput").value || "æœªå…¥åŠ›").trim() || "æœªå…¥åŠ›";
}

/* =========================
   PIN è¨˜æ†¶ï¼ˆlocalStorageï¼‰
   ========================= */
function loadSavedPin() {
  const saved = localStorage.getItem("inv_pin") || "";
  document.getElementById("pinInput").value = saved;
}
function savePinOnChange() {
  const el = document.getElementById("pinInput");
  el.addEventListener("input", () => localStorage.setItem("inv_pin", el.value));
}
function checkPin() {
  if (!EDIT_PIN) return true; // PINãªã—é‹ç”¨
  const entered = (document.getElementById("pinInput").value || "").trim();
  if (entered !== EDIT_PIN) {
    alert("PINãŒé•ã„ã¾ã™ï¼ˆæ“ä½œã§ãã¾ã›ã‚“ï¼‰");
    return false;
  }
  return true;
}

/* =========================
   Load & Render
   ========================= */
window.onload = async () => {
  loadSavedPin();
  savePinOnChange();
  setStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
  await loadAll();
};

async function loadAll() {
  const s = await supabaseClient.from("stocks").select("*").order("name");
  if (s.error) return showErr("stocks èª­ã¿è¾¼ã¿å¤±æ•—", s.error);

  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("history èª­ã¿è¾¼ã¿å¤±æ•—", h.error);

  renderStocks(s.data || []);
  renderHistory(h.data || []);
  renderMonthly(h.data || []);
  setStatus("æº–å‚™OKï¼ˆURLé–‹ã‘ã°ã™ãä½¿ãˆã¾ã™ï¼‰", true);
}

function renderStocks(stocks) {
  const table = document.getElementById("stockTable");
  table.innerHTML = "<tr><th>å•†å“</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr>";

  stocks.forEach(s => {
    const tr = table.insertRow();
    if (Number(s.qty) <= ALERT_QTY) tr.className = "low";

    tr.innerHTML = `
      <td>${escapeHtml(s.name)}</td>
      <td>${Number(s.qty)}</td>
      <td>
        <button onclick="shipItem('${escapeJs(s.name)}')">å‡ºåº«</button>
        <button onclick="editQty('${escapeJs(s.name)}', ${Number(s.qty)})">ç·¨é›†</button>
        <button onclick="deleteItem('${escapeJs(s.name)}')">å‰Šé™¤</button>
      </td>
    `;
  });
}

function renderHistory(history) {
  const table = document.getElementById("historyTable");
  table.innerHTML = "<tr><th>æ—¥æ™‚</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>ç¨®åˆ¥</th><th>å•†å“</th><th>æ•°é‡</th></tr>";
  history.forEach(h => {
    const tr = table.insertRow();
    tr.innerHTML = `
      <td>${escapeHtml(h.date)}</td>
      <td>${escapeHtml(h.user)}</td>
      <td>${escapeHtml(h.type)}</td>
      <td>${escapeHtml(h.name)}</td>
      <td>${escapeHtml(String(h.qty))}</td>
    `;
  });
}

/* =========================
   B) æœˆæ¬¡å‡ºåº«é›†è¨ˆ
   ========================= */
function renderMonthly(history) {
  const table = document.getElementById("monthlyTable");
  const map = {}; // YYYY-MM -> count

  history
    .filter(h => h.type === "å‡ºåº«")
    .forEach(h => {
      const ym = String(h.date).slice(0, 7);
      map[ym] = (map[ym] || 0) + Number(h.qty || 0);
    });

  table.innerHTML = "<tr><th>æœˆ</th><th>å‡ºåº«æ•°</th></tr>";
  Object.keys(map).sort().forEach(ym => {
    const tr = table.insertRow();
    tr.innerHTML = `<td>${escapeHtml(ym)}</td><td>${map[ym]}</td>`;
  });

  if (Object.keys(map).length === 0) {
    const tr = table.insertRow();
    tr.innerHTML = `<td colspan="2">ã¾ã å‡ºåº«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td>`;
  }
}

/* =========================
   CRUD operations
   ========================= */
async function addItem() {
  if (!checkPin()) return;

  const name = (document.getElementById("nameInput").value || "").trim();
  const qty = Number(document.getElementById("qtyInput").value);
  if (!name || !qty) return alert("å•†å“åã¨æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks æ—¢å­˜ãƒã‚§ãƒƒã‚¯å¤±æ•—", ex.error);

  if (ex.data) {
    const up = await supabaseClient.from("stocks").update({ qty: Number(ex.data.qty) + qty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update å¤±æ•—", up.error);
  } else {
    const ins = await supabaseClient.from("stocks").insert({ name, qty });
    if (ins.error) return showErr("stocks insert å¤±æ•—", ins.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "å…¥åº«",
    name,
    qty
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  document.getElementById("nameInput").value = "";
  document.getElementById("qtyInput").value = "";

  await loadAll();
}

async function shipItem(name) {
  if (!checkPin()) return;

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks å–å¾—å¤±æ•—", ex.error);
  if (!ex.data) return;

  const newQty = Number(ex.data.qty) - 1;

  if (newQty <= 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete å¤±æ•—", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update å¤±æ•—", up.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "å‡ºåº«",
    name,
    qty: 1
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  await loadAll();
}

async function editQty(name, currentQty) {
  if (!checkPin()) return;

  const input = prompt(`åœ¨åº«æ•°ã‚’å¤‰æ›´ï¼ˆå•†å“: ${name}ï¼‰\nç¾åœ¨: ${currentQty}\næ–°ã—ã„æ•°é‡`, String(currentQty));
  if (input === null) return;
  const newQty = Number(input);
  if (!Number.isFinite(newQty) || newQty < 0) return alert("0ä»¥ä¸Šã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks å–å¾—å¤±æ•—", ex.error);
  if (!ex.data) return alert("å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

  if (newQty === 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete å¤±æ•—", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update å¤±æ•—", up.error);
  }

  const diff = newQty - Number(ex.data.qty);
  const type = diff >= 0 ? "ç·¨é›†ï¼ˆå¢—ï¼‰" : "ç·¨é›†ï¼ˆæ¸›ï¼‰";

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type,
    name,
    qty: Math.abs(diff)
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  await loadAll();
}

async function deleteItem(name) {
  if (!checkPin()) return;
  if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ`)) return;

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks å–å¾—å¤±æ•—", ex.error);
  if (!ex.data) return;

  const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
  if (del.error) return showErr("stocks delete å¤±æ•—", del.error);

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "å‰Šé™¤",
    name,
    qty: 0
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  await loadAll();
}

/* =========================
   A) CSV Exportï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
   ========================= */
function downloadText(filename, text) {
  const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
function todayStr() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}${m}${day}`;
}
function csvEscape(v) {
  const s = String(v ?? "");
  if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
  return s;
}

async function exportStocksCSV() {
  const s = await supabaseClient.from("stocks").select("*").order("name");
  if (s.error) return showErr("åœ¨åº«CSVå–å¾—å¤±æ•—", s.error);

  let csv = "name,qty\n";
  (s.data || []).forEach(r => { csv += `${csvEscape(r.name)},${Number(r.qty)}\n`; });
  downloadText(`stocks_${todayStr()}.csv`, csv);
}

async function exportHistoryCSV() {
  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("å±¥æ­´CSVå–å¾—å¤±æ•—", h.error);

  let csv = "date,user,type,name,qty\n";
  (h.data || []).forEach(r => {
    csv += `${csvEscape(r.date)},${csvEscape(r.user)},${csvEscape(r.type)},${csvEscape(r.name)},${csvEscape(String(r.qty))}\n`;
  });
  downloadText(`history_${todayStr()}.csv`, csv);
}

/* =========================
   C) CSV Importï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
   ========================= */
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  for (let i=0; i<text.length; i++) {
    const ch = text[i];
    const next = text[i+1];

    if (ch === '"' ) {
      if (inQ && next === '"') { cur += '"'; i++; }
      else { inQ = !inQ; }
      continue;
    }
    if (!inQ && ch === ",") { row.push(cur); cur = ""; continue; }
    if (!inQ && (ch === "\n" || ch === "\r")) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur); rows.push(row);
      row = []; cur = "";
      continue;
    }
    cur += ch;
  }
  if (cur.length > 0 || row.length > 0) { row.push(cur); rows.push(row); }
  return rows;
}

async function importStocksCSV(inputEl) {
  if (!checkPin()) { inputEl.value = ""; return; }
  const file = inputEl.files?.[0];
  if (!file) return;

  const text = await file.text();
  const rows = parseCSV(text)
    .map(r => r.map(c => (c ?? "").trim()))
    .filter(r => r.length >= 2 && r[0] && r[1]);

  // ãƒ˜ãƒƒãƒ€ãƒ¼é™¤å¤–
  const dataRows = rows.filter(r => !(r[0].toLowerCase()==="name" && r[1].toLowerCase().startsWith("qty")));

  // æ—¢å­˜åœ¨åº«ã‚’å–å¾—ã—ã¦ upsert
  const existing = await supabaseClient.from("stocks").select("*");
  if (existing.error) return showErr("æ—¢å­˜åœ¨åº«å–å¾—å¤±æ•—", existing.error);
  const map = new Map((existing.data || []).map(x => [x.name, x]));

  for (const [nameRaw, qtyRaw] of dataRows) {
    const name = nameRaw;
    const qty = Number(qtyRaw);
    if (!name || !Number.isFinite(qty) || qty < 0) continue;

    const found = map.get(name);
    if (found) {
      const up = await supabaseClient.from("stocks").update({ qty }).eq("id", found.id);
      if (up.error) return showErr(`åœ¨åº«CSVåæ˜  updateå¤±æ•—ï¼ˆ${name}ï¼‰`, up.error);
    } else {
      const ins = await supabaseClient.from("stocks").insert({ name, qty });
      if (ins.error) return showErr(`åœ¨åº«CSVåæ˜  insertå¤±æ•—ï¼ˆ${name}ï¼‰`, ins.error);
    }

    const hin = await supabaseClient.from("history").insert({
      date: new Date().toISOString(),
      user: currentUser(),
      type: "CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆåœ¨åº«ï¼‰",
      name,
      qty
    });
    if (hin.error) return showErr(`å±¥æ­´æ›¸ãè¾¼ã¿å¤±æ•—ï¼ˆ${name}ï¼‰`, hin.error);
  }

  inputEl.value = "";
  await loadAll();
  alert("åœ¨åº«CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†");
}

async function importHistoryCSV(inputEl) {
  if (!checkPin()) { inputEl.value = ""; return; }
  const file = inputEl.files?.[0];
  if (!file) return;

  const text = await file.text();
  const rows = parseCSV(text)
    .map(r => r.map(c => (c ?? "").trim()))
    .filter(r => r.length >= 5);

  // ãƒ˜ãƒƒãƒ€ãƒ¼é™¤å¤–
  const dataRows = rows.filter(r => !(r[0].toLowerCase()==="date" && r[1].toLowerCase()==="user"));

  for (const r of dataRows) {
    const [date, user, type, name, qtyRaw] = r;
    if (!date || !type || !name) continue;
    const qty = Number(qtyRaw);
    if (!Number.isFinite(qty)) continue;

    const ins = await supabaseClient.from("history").insert({
      date,
      user: user || currentUser(),
      type,
      name,
      qty
    });
    if (ins.error) return showErr(`å±¥æ­´CSV insertå¤±æ•—ï¼ˆ${name}ï¼‰`, ins.error);
  }

  inputEl.value = "";
  await loadAll();
  alert("å±¥æ­´CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†");
}

/* =========================
   escaping
   ========================= */
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
function escapeJs(s) {
  return String(s ?? "").replaceAll("\\", "\\\\").replaceAll("'", "\\'").replaceAll("\n", " ").replaceAll("\r"," ");
}
</script>
</body>
</html>
