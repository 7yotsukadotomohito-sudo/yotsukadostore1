<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>在庫管理システム</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;

    --primary:#2563eb;
    --primaryHover:#1d4ed8;
    --danger:#dc2626;
    --dangerHover:#b91c1c;
    --ghost:#e5e7eb;
    --ghostHover:#d1d5db;

    --goodBg:#ecfdf5;
    --goodLine:#86efac;
    --badBg:#fff1f2;
    --badLine:#fca5a5;

    --lowBg:#fff1f2;
    --lowText:#9f1239;

    --radius:14px;
    --shadow:0 8px 24px rgba(17,24,39,.08);
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Helvetica Neue", Arial;
    color:var(--text);
    background:var(--bg);
  }

  code{
    background:#f3f4f6;
    padding:2px 6px;
    border-radius:8px;
    font-size: 12px;
  }

  .container{
    max-width: 1240px;
    margin: 0 auto;
    padding: 18px;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    margin-bottom: 14px;
  }

  .title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  h1{
    font-size: 22px;
    margin:0;
    letter-spacing: .02em;
  }
  .subtitle{
    color: var(--muted);
    font-size: 13px;
  }

  .topActions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 14px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  @media (max-width: 900px){
    .grid{ grid-template-columns: 1fr; }
  }

  .sectionTitle{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 8px;
    margin: 0 0 10px 0;
  }
  .sectionTitle h2{
    margin:0;
    font-size: 16px;
  }
  .hint{
    color:var(--muted);
    font-size: 12px;
  }

  #status{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: #fff;
    margin-bottom: 12px;
    font-size: 13px;
  }
  #status.good{ background: var(--goodBg); border-color: var(--goodLine); }
  #status.bad{ background: var(--badBg); border-color: var(--badLine); }

  .row{
    display:flex;
    gap: 10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width: 180px;
    flex: 1;
  }
  .field label{
    font-size: 12px;
    color: var(--muted);
  }

  input[type="text"], input[type="password"], input[type="number"]{
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border:1px solid var(--line);
    outline: none;
    background:#fff;
    font-size: 14px;
  }
  input:focus{
    border-color: rgba(37,99,235,.55);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }

  input[type="file"]{ padding: 10px 0; }

  button{
    border: none;
    border-radius: 12px;
    padding: 10px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: transform .02s ease, background .15s ease, opacity .15s ease;
    user-select:none;
    white-space:nowrap;
  }
  button:active{ transform: translateY(1px); }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  .btn-primary{ background: var(--primary); color: #fff; }
  .btn-primary:hover{ background: var(--primaryHover); }

  .btn-danger{ background: var(--danger); color: #fff; }
  .btn-danger:hover{ background: var(--dangerHover); }

  .btn-ghost{ background: var(--ghost); color: var(--text); }
  .btn-ghost:hover{ background: var(--ghostHover); }

  .btn-small{
    padding: 7px 10px;
    border-radius: 10px;
    font-size: 13px;
  }

  .tableCard{ padding: 0; overflow: hidden; }
  .tableHeader{
    padding: 12px 14px;
    border-bottom: 1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .tableHeader h2{
    margin:0;
    font-size: 16px;
  }
  .tableWrap{
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* ★ 表っぽく区切る：罫線 & セル境界 */
  table{
    width: 100%;
    border-collapse: collapse;
    min-width: 1180px;
    background: #fff;
    border: 1px solid var(--line);
  }
  th, td{
    padding: 12px 12px;
    text-align: left;
    font-size: 14px;
    border: 1px solid var(--line);
    vertical-align: top;
  }
  th{
    background: #fafafa;
    color:#374151;
    font-weight: 800;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  td.qty{
    text-align: right;
    font-variant-numeric: tabular-nums;
    font-weight: 800;
    white-space: nowrap;
  }
  td.center{ text-align:center; }
  .muted{ color:var(--muted); font-size: 12px; }

  tr.low-stock td{
    background: var(--lowBg);
    color: var(--lowText);
  }

  /* ★ 商品名が2文字で折れる問題対策：列幅を確保＋折り返し/フォント */
  td.nameCell{
    min-width: 340px;      /* ここで「10文字くらい」を出せる */
    max-width: 520px;
    white-space: normal;   /* 折り返し可 */
    word-break: break-word;
    font-size: 13px;       /* 少しだけ小さく */
    line-height: 1.35;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap: 6px;
    padding: 6px 10px;
    border: 1px solid var(--line);
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
    background:#fff;
  }

  @media (max-width: 600px){
    .topActions{ width:100%; justify-content:flex-start; }
    .row.actions{ flex-direction: column; align-items: stretch; }
    .row.actions button{ width: 100%; }
    table{ min-width: 1280px; }
  }
</style>
</head>

<body>
<div class="container">

  <header>
    <div class="title">
      <h1>在庫管理システム</h1>
      <div class="subtitle">UI v6（反映確認用） / 罫線テーブル / 商品名見やすく / 棚卸CSV / 在庫数CSV</div>
    </div>

    <div class="topActions">
      <button class="btn-ghost" onclick="loadAll()">最新に更新</button>
      <span class="pill">既定アラート: <b id="alertBadge">3</b> 以下（SKU別に上書き可）</span>
    </div>
  </header>

  <div id="status" class="good">状態: 起動中…</div>

  <div class="grid">
    <div class="card">
      <div class="sectionTitle">
        <h2>編集PIN</h2>
        <div class="hint">※PINはブラウザに記憶されます</div>
      </div>
      <div class="row">
        <div class="field" style="max-width:260px;">
          <label>PIN（操作する人だけ入力）</label>
          <input id="pinInput" type="password" placeholder="PIN" />
        </div>
        <button class="btn-ghost" onclick="clearSavedPin()">PINを忘れる</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        閲覧は誰でもOK / 編集はPIN入力が必要
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">
        <h2>ユーザー名（履歴用）</h2>
        <div class="hint">※未入力でもOK</div>
      </div>
      <div class="row">
        <div class="field" style="max-width:260px;">
          <label>履歴に残す名前</label>
          <input id="userInput" placeholder="例：山田" />
        </div>
      </div>
      <div class="muted" style="margin-top:10px;">
        「誰が操作したか」を残したいときに入力
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <div class="sectionTitle">
        <h2>入庫（手入力）</h2>
        <div class="hint">SKU必須 / 商品名は任意 / アラート閾値も設定可</div>
      </div>

      <div class="row actions">
        <div class="field">
          <label>SKU（必須）</label>
          <input id="skuInput" placeholder="SKU（必須）" />
        </div>
        <div class="field">
          <label>商品名（任意）</label>
          <input id="nameInput" placeholder="商品名（任意）" />
        </div>
        <div class="field" style="max-width:160px;">
          <label>数量</label>
          <input id="qtyInput" type="number" placeholder="数量" />
        </div>
        <div class="field" style="max-width:220px;">
          <label>アラート閾値（任意）</label>
          <input id="alertInput" type="number" placeholder="例：3（空欄＝既定）" />
        </div>
        <button class="btn-primary" onclick="addItemManual()">入庫</button>
      </div>
      <div class="muted" style="margin-top:8px;">
        SKUが既に存在する場合は在庫を加算（商品名/閾値は入力があれば更新）
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">
        <h2>CSV / メンテ</h2>
        <div class="hint">バックアップ・棚卸・不足リスト</div>
      </div>

      <div class="row actions" style="margin-bottom:10px;">
        <button class="btn-ghost" onclick="exportStocksCSV()">在庫CSV（詳細）</button>
        <button class="btn-ghost" onclick="exportSkuQtyCSV()">在庫数CSV（sku,qty）</button>
        <button class="btn-ghost" onclick="exportHistoryCSV()">履歴CSV</button>
        <button class="btn-primary" onclick="exportLowStockCSV()">不足（アラート対象）CSV</button>
      </div>

      <div class="row actions" style="margin-top:10px;">
        <button class="btn-ghost" onclick="bulkFillAlertQty()">未設定のalert_qtyを一括で既定値にする</button>
        <span class="muted">（既定: <b id="alertLabel">3</b>）</span>
      </div>

      <div style="margin-top:14px; border-top:1px dashed var(--line); padding-top:12px;">
        <div style="font-weight:800; margin-bottom:6px;">在庫CSVインポート（増減/上書き）</div>
        <div class="row">
          <input type="file" accept=".csv,text/csv" onchange="importStocksCSV(this)" />
        </div>
        <div class="muted" style="margin-top:8px; line-height:1.55;">
          形式A（増減）：<code>sku,name,delta,alert_qty</code><br>
          形式B（上書き）：<code>sku,name,qty,alert_qty</code><br>
          ※skuが空ならname照合。qty=0は削除扱い。alert_qty空欄は既存維持（新規は既定）。
        </div>
      </div>

      <div style="margin-top:14px; border-top:1px dashed var(--line); padding-top:12px;">
        <div style="font-weight:800; margin-bottom:6px;">棚卸CSVインポート（実在個で上書き）</div>
        <div class="row">
          <input type="file" accept=".csv,text/csv" onchange="importStocktakeCSV(this)" />
        </div>
        <div class="muted" style="margin-top:8px; line-height:1.55;">
          形式：<code>sku,qty</code>（ヘッダあり/なし両対応）<br>
          ※CSVにあるSKUだけ在庫を上書きします（差分は履歴に <code>棚卸</code> として記録）。
        </div>
      </div>

    </div>
  </div>

  <div class="card tableCard" style="margin-top:12px;">
    <div class="tableHeader">
      <h2>在庫一覧</h2>
      <div class="hint">SKU昇順 / 少数在庫はハイライト（SKU別閾値、未設定は既定）</div>
    </div>
    <div class="tableWrap">
      <table id="stockTable"></table>
    </div>
  </div>

  <div class="card tableCard" style="margin-top:12px;">
    <div class="tableHeader">
      <h2>月次出庫集計</h2>
      <div class="hint">history の「出庫」から算出</div>
    </div>
    <div class="tableWrap">
      <table id="monthlyTable"></table>
    </div>
  </div>

  <div class="card tableCard" style="margin-top:12px; margin-bottom:18px;">
    <div class="tableHeader">
      <h2>入出庫履歴</h2>
      <div class="hint">東京時間（JST） / 最新が上</div>
    </div>
    <div class="tableWrap">
      <table id="historyTable"></table>
    </div>
  </div>

</div>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL = "https://dabhwrkugxxbkvwlcyxi.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhYmh3cmt1Z3h4Ymt2d2xjeXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjAwNjksImV4cCI6MjA4Mjg5NjA2OX0.G60_QQy0SOY7w-72Mq-gMoq99kUPj1I6c13G2SxOHeQ";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ✅ 運用PIN（空文字ならPINなし） */
const EDIT_PIN = "1234";

/* 既定アラート閾値（SKU別にalert_qtyで上書き可） */
const DEFAULT_ALERT_QTY = 3;

/* ========= UI helpers ========= */
function setStatus(msg, ok=true) {
  const el = document.getElementById("status");
  el.textContent = "状態: " + msg;
  el.className = ok ? "good" : "bad";
}
function showErr(context, err) {
  console.error(context, err);
  const detail = err ? (err.message || JSON.stringify(err)) : "unknown";
  alert(`${context}\n\n${detail}`);
  setStatus(`${context} → ${detail}`, false);
}
function currentUser() {
  return (document.getElementById("userInput").value || "未入力").trim() || "未入力";
}
function getAlertQtyForRow(row){
  const v = row?.alert_qty;
  const n = Number(v);
  if (Number.isFinite(n) && n >= 0) return n;
  return DEFAULT_ALERT_QTY;
}
function shortageForRow(row){
  const qty = Number(row?.qty || 0);
  const alertQty = getAlertQtyForRow(row);
  return Math.max(0, alertQty - qty);
}
function normalizeAlertInput(raw){
  const s = String(raw ?? "").trim();
  if (s === "") return null;
  const n = Number(s);
  if (!Number.isFinite(n) || n < 0) return { error: "アラート閾値は0以上の数字で入力してください（空欄＝既定）" };
  return n;
}

/* ========= PIN 記憶 ========= */
function loadSavedPin() {
  const saved = localStorage.getItem("inv_pin") || "";
  document.getElementById("pinInput").value = saved;
}
function savePinOnChange() {
  const el = document.getElementById("pinInput");
  el.addEventListener("input", () => localStorage.setItem("inv_pin", el.value));
}
function clearSavedPin(){
  localStorage.removeItem("inv_pin");
  document.getElementById("pinInput").value = "";
  setStatus("PINをクリアしました（閲覧のみ）", true);
}
function checkPin() {
  if (!EDIT_PIN) return true;
  const entered = (document.getElementById("pinInput").value || "").trim();
  if (entered !== EDIT_PIN) {
    alert("PINが違います（操作できません）");
    return false;
  }
  return true;
}

/* ========= Load & Render ========= */
window.onload = async () => {
  document.getElementById("alertBadge").textContent = String(DEFAULT_ALERT_QTY);
  document.getElementById("alertLabel").textContent = String(DEFAULT_ALERT_QTY);

  loadSavedPin();
  savePinOnChange();
  setStatus("読み込み中…");
  await loadAll();
};

async function loadAll() {
  setStatus("読み込み中…");
  const s = await supabaseClient.from("stocks").select("*").order("sku");
  if (s.error) return showErr("stocks 読み込み失敗", s.error);

  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("history 読み込み失敗", h.error);

  window.__stocks_cache__ = (s.data || []);
  renderStocks(window.__stocks_cache__);
  renderHistory(h.data || []);
  renderMonthly(h.data || []);
  setStatus("準備OK", true);
}

function renderStocks(stocks) {
  const table = document.getElementById("stockTable");
  table.innerHTML = `
    <tr>
      <th style="width:170px;">SKU</th>
      <th style="min-width:340px;">商品</th>
      <th style="width:110px; text-align:right;">数量</th>
      <th style="width:120px; text-align:right;">アラート</th>
      <th style="width:80px; text-align:right;">差</th>
      <th style="width:520px;">操作</th>
    </tr>`;

  if (!stocks.length){
    const tr = table.insertRow();
    tr.innerHTML = `<td colspan="6" class="center muted">まだ在庫がありません</td>`;
    return;
  }

  stocks.forEach(s => {
    const qty = Number(s.qty || 0);
    const alertQty = getAlertQtyForRow(s);
    const shortage = shortageForRow(s);

    const tr = table.insertRow();
    if (qty <= alertQty) tr.classList.add("low-stock");

    const alertLabel = (s.alert_qty === null || s.alert_qty === undefined || s.alert_qty === "") ? `既定(${DEFAULT_ALERT_QTY})` : String(alertQty);

    tr.innerHTML = `
      <td class="muted">${escapeHtml(s.sku || "")}</td>
      <td class="nameCell">${escapeHtml(s.name || "")}</td>
      <td class="qty">${qty}</td>
      <td class="qty">${escapeHtml(alertLabel)}</td>
      <td class="qty">${shortage}</td>
      <td>
        <button class="btn-primary btn-small" onclick="shipItem('${escapeJs(s.sku||"")}', '${escapeJs(s.name||"")}')">出庫(-1)</button>
        <button class="btn-ghost btn-small" onclick="shipItemQty('${escapeJs(s.sku||"")}', '${escapeJs(s.name||"")}')">数量出庫</button>
        <button class="btn-ghost btn-small" onclick="editItemInfo('${escapeJs(s.sku||"")}', '${escapeJs(s.name||"")}')">SKU/商品名/アラート編集</button>
        <button class="btn-ghost btn-small" onclick="editQty('${escapeJs(s.sku||"")}', '${escapeJs(s.name||"")}', ${qty})">在庫編集</button>
        <button class="btn-danger btn-small" onclick="deleteItem('${escapeJs(s.sku||"")}', '${escapeJs(s.name||"")}')">削除</button>
      </td>
    `;
  });
}

function renderHistory(history) {
  const table = document.getElementById("historyTable");
  table.innerHTML = `
    <tr>
      <th style="width:190px;">日時（JST）</th>
      <th style="width:120px;">ユーザー</th>
      <th style="width:180px;">種別</th>
      <th style="width:160px;">SKU</th>
      <th>商品</th>
      <th style="width:110px; text-align:right;">数量</th>
    </tr>`;

  if (!history.length){
    const tr = table.insertRow();
    tr.innerHTML = `<td colspan="6" class="center muted">まだ履歴がありません</td>`;
    return;
  }

  history.forEach(h => {
    const tr = table.insertRow();
    tr.innerHTML = `
      <td class="muted">${escapeHtml(formatDate(h.date))}</td>
      <td>${escapeHtml(h.user)}</td>
      <td>${escapeHtml(h.type)}</td>
      <td class="muted">${escapeHtml(h.sku || "")}</td>
      <td class="nameCell">${escapeHtml(h.name || "")}</td>
      <td class="qty">${escapeHtml(String(h.qty))}</td>
    `;
  });
}

/* ========= 月次出庫 ========= */
function renderMonthly(history) {
  const table = document.getElementById("monthlyTable");
  const map = {};
  history.filter(h => h.type === "出庫").forEach(h => {
    const ym = String(h.date).slice(0,7);
    map[ym] = (map[ym] || 0) + Number(h.qty || 0);
  });

  table.innerHTML = `
    <tr>
      <th style="width:160px;">月</th>
      <th style="width:140px; text-align:right;">出庫数</th>
    </tr>`;

  const keys = Object.keys(map).sort();
  if (!keys.length) {
    table.insertRow().innerHTML = `<td colspan="2" class="center muted">まだ出庫履歴がありません</td>`;
    return;
  }
  keys.forEach(ym => {
    const tr = table.insertRow();
    tr.innerHTML = `<td>${escapeHtml(ym)}</td><td class="qty">${map[ym]}</td>`;
  });
}

/* ========= 一括：alert_qty 未設定を既定値へ ========= */
async function bulkFillAlertQty(){
  if (!checkPin()) return;

  const ok = confirm(`alert_qty が未設定のSKUに、既定値(${DEFAULT_ALERT_QTY})を一括設定します。OK？`);
  if (!ok) return;

  setStatus("一括更新中…", true);

  const r = await supabaseClient
    .from("stocks")
    .update({ alert_qty: DEFAULT_ALERT_QTY })
    .is("alert_qty", null);

  if (r.error) return showErr("alert_qty 一括更新失敗", r.error);

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "alert_qty一括設定",
    sku: null,
    name: "",
    qty: 0
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
  alert("未設定のalert_qtyを既定値にしました");
}

/* ========= 照合：SKU優先、なければ商品名 ========= */
async function findStockRow(sku, name) {
  if (sku) return await supabaseClient.from("stocks").select("*").eq("sku", sku).maybeSingle();
  return await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
}

/* ========= 手入力入庫 ========= */
async function addItemManual() {
  if (!checkPin()) return;

  const sku = (document.getElementById("skuInput").value || "").trim();
  const name = (document.getElementById("nameInput").value || "").trim();
  const qty = Number(document.getElementById("qtyInput").value);
  const alertRaw = document.getElementById("alertInput").value;

  if (!sku || !qty) return alert("SKUと数量は必須です");

  const alertVal = normalizeAlertInput(alertRaw);
  if (alertVal && alertVal.error) return alert(alertVal.error);

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 既存チェック失敗", ex.error);

  if (ex.data) {
    const newQty = Number(ex.data.qty || 0) + qty;
    const payload = { qty: newQty };
    if (name) payload.name = name;
    if (alertVal !== null) payload.alert_qty = alertVal;
    const up = await supabaseClient.from("stocks").update(payload).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update 失敗", up.error);
  } else {
    const payload = { sku, name: name || "", qty };
    if (alertVal !== null) payload.alert_qty = alertVal;
    const ins = await supabaseClient.from("stocks").insert(payload);
    if (ins.error) return showErr("stocks insert 失敗", ins.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "入庫",
    sku,
    name: name || "",
    qty
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  document.getElementById("skuInput").value = "";
  document.getElementById("nameInput").value = "";
  document.getElementById("qtyInput").value = "";
  document.getElementById("alertInput").value = "";

  await loadAll();
}

/* ========= 出庫 ========= */
async function shipItem(sku, name) {
  if (!checkPin()) return;

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return;

  const newQty = Number(ex.data.qty) - 1;

  if (newQty <= 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete 失敗", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update 失敗", up.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "出庫",
    sku: ex.data.sku || sku,
    name: ex.data.name || "",
    qty: 1
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

async function shipItemQty(sku, name) {
  if (!checkPin()) return;

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return;

  const current = Number(ex.data.qty || 0);
  const input = prompt(
    `数量出庫（SKU: ${sku||"-"} / 商品: ${ex.data.name || ""}）\n現在: ${current}\n出庫数量（1以上）`,
    "1"
  );
  if (input === null) return;

  const n = Number(input);
  if (!Number.isFinite(n) || n <= 0) return alert("1以上の数字を入力してください");

  const newQty = current - n;

  if (newQty <= 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete 失敗", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update 失敗", up.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "出庫",
    sku: ex.data.sku || sku,
    name: ex.data.name || "",
    qty: n
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

/* ========= SKU/商品名/アラート 編集 ========= */
async function editItemInfo(oldSku, oldName) {
  if (!checkPin()) return;

  const ex = await findStockRow(oldSku, oldName);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return alert("商品が見つかりません");

  const curSku = (ex.data.sku || "").trim();
  const curName = (ex.data.name || "").trim();
  const curAlert = (ex.data.alert_qty === null || ex.data.alert_qty === undefined) ? "" : String(ex.data.alert_qty);

  const newSku = prompt(`SKUを編集（必須）\n現在: ${curSku}`, curSku);
  if (newSku === null) return;
  if (!newSku.trim()) return alert("SKUは必須です");

  const newName = prompt(`商品名を編集（任意）\n現在: ${curName}`, curName);
  if (newName === null) return;

  const newAlertRaw = prompt(
    `アラート閾値を編集（任意）\n空欄＝既定(${DEFAULT_ALERT_QTY})\n現在: ${curAlert === "" ? "（既定）" : curAlert}`,
    curAlert
  );
  if (newAlertRaw === null) return;

  const alertVal = normalizeAlertInput(newAlertRaw);
  if (alertVal && alertVal.error) return alert(alertVal.error);

  const dup = await supabaseClient.from("stocks").select("id").eq("sku", newSku.trim()).maybeSingle();
  if (dup.error) return showErr("SKU重複チェック失敗", dup.error);
  if (dup.data && dup.data.id !== ex.data.id) return alert(`SKU「${newSku.trim()}」は既に存在します。別のSKUにしてください。`);

  const payload = { sku: newSku.trim(), name: (newName || "").trim(), alert_qty: (alertVal === null) ? null : alertVal };
  const up = await supabaseClient.from("stocks").update(payload).eq("id", ex.data.id);
  if (up.error) return showErr("stocks update 失敗", up.error);

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "商品情報編集",
    sku: payload.sku,
    name: payload.name,
    qty: 0
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

/* ========= 在庫編集 / 削除 ========= */
async function editQty(sku, name, currentQty) {
  if (!checkPin()) return;

  const input = prompt(`在庫数を変更（SKU: ${sku||"-"} / 商品: ${name||""}）\n現在: ${currentQty}\n新しい数量`, String(currentQty));
  if (input === null) return;

  const newQty = Number(input);
  if (!Number.isFinite(newQty) || newQty < 0) return alert("0以上の数字を入力してください");

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return alert("商品が見つかりません");

  if (newQty === 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete 失敗", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update 失敗", up.error);
  }

  const diff = newQty - Number(ex.data.qty);
  const type = diff >= 0 ? "編集（増）" : "編集（減）";

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type,
    sku: ex.data.sku || sku,
    name: ex.data.name || "",
    qty: Math.abs(diff)
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

async function deleteItem(sku, name) {
  if (!checkPin()) return;
  if (!confirm(`SKU「${sku}」を削除します。OK？`)) return;

  const ex = await findStockRow(sku, name);
  if (ex.error) return showErr("stocks 取得失敗", ex.error);
  if (!ex.data) return;

  const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
  if (del.error) return showErr("stocks delete 失敗", del.error);

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "削除",
    sku: ex.data.sku || sku,
    name: ex.data.name || "",
    qty: 0
  });
  if (hin.error) return showErr("history insert 失敗", hin.error);

  await loadAll();
}

/* ========= CSV Export ========= */
function downloadText(filename, text) {
  const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
}
function csvEscape(v) {
  const s = String(v ?? "");
  if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

/* 詳細（既存） */
async function exportStocksCSV() {
  const s = await supabaseClient.from("stocks").select("*").order("sku");
  if (s.error) return showErr("在庫CSV取得失敗", s.error);

  let csv = "sku,name,qty,alert_qty,shortage\n";
  (s.data || []).forEach(r => {
    const aq = (r.alert_qty === null || r.alert_qty === undefined) ? "" : String(r.alert_qty);
    const alertNum = (aq === "") ? DEFAULT_ALERT_QTY : Number(aq);
    const sh = Math.max(0, alertNum - Number(r.qty || 0));
    csv += `${csvEscape(r.sku||"")},${csvEscape(r.name||"")},${Number(r.qty||0)},${csvEscape(aq)},${sh}\n`;
  });
  downloadText(`stocks_${todayStr()}.csv`, csv);
}

/* ★ 全SKUの在庫数だけ（今回追加） */
async function exportSkuQtyCSV(){
  const s = await supabaseClient.from("stocks").select("sku,qty").order("sku");
  if (s.error) return showErr("在庫数CSV取得失敗", s.error);

  let csv = "sku,qty\n";
  (s.data || []).forEach(r => {
    csv += `${csvEscape(r.sku||"")},${Number(r.qty||0)}\n`;
  });
  downloadText(`sku_qty_${todayStr()}.csv`, csv);
}

function exportLowStockCSV(){
  const stocks = window.__stocks_cache__ || [];
  const low = stocks
    .map(r => ({...r, _alert: getAlertQtyForRow(r), _short: shortageForRow(r)}))
    .filter(r => Number(r.qty || 0) <= r._alert);

  let csv = "sku,name,qty,alert_qty,shortage\n";
  low.forEach(r => {
    const aq = (r.alert_qty === null || r.alert_qty === undefined) ? "" : String(r.alert_qty);
    csv += `${csvEscape(r.sku||"")},${csvEscape(r.name||"")},${Number(r.qty || 0)},${csvEscape(aq)},${Number(r._short)}\n`;
  });

  downloadText(`low_stock_${todayStr()}.csv`, csv);
  alert(`不足CSVを出力しました（${low.length}件）`);
}

async function exportHistoryCSV() {
  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("履歴CSV取得失敗", h.error);

  let csv = "date,user,type,sku,name,qty\n";
  (h.data || []).forEach(r => {
    csv += `${csvEscape(r.date)},${csvEscape(r.user)},${csvEscape(r.type)},${csvEscape(r.sku||"")},${csvEscape(r.name||"")},${csvEscape(String(r.qty))}\n`;
  });
  downloadText(`history_${todayStr()}.csv`, csv);
}

/* ========= CSV Import（増減/上書き） ========= */
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  for (let i=0; i<text.length; i++) {
    const ch = text[i], next = text[i+1];
    if (ch === '"') {
      if (inQ && next === '"') { cur += '"'; i++; }
      else inQ = !inQ;
      continue;
    }
    if (!inQ && ch === ",") { row.push(cur); cur=""; continue; }
    if (!inQ && (ch === "\n" || ch === "\r")) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur); rows.push(row);
      row=[]; cur=""; continue;
    }
    cur += ch;
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

async function importStocksCSV(inputEl) {
  if (!checkPin()) { inputEl.value = ""; return; }
  const file = inputEl.files?.[0];
  if (!file) return;

  setStatus("CSV読み込み中…", true);

  const text = await file.text();
  const rows = parseCSV(text).map(r => r.map(c => (c ?? "").trim())).filter(r => r.length >= 2);
  if (!rows.length) { alert("CSVが空です"); inputEl.value = ""; return; }

  let countProcessed = 0, countUpdated = 0, countInserted = 0, countDeleted = 0, countSkipped = 0;
  const errors = [];
  const pushError = (line, msg) => errors.push(`行${line}: ${msg}`);

  const header = rows[0].map(x => x.toLowerCase());
  const hasHeader = header.includes("name") || header.includes("sku") || header.includes("qty") || header.includes("delta") || header.includes("alert_qty");

  let dataRows = rows;
  let mode = "set";
  let idxSku = 0, idxName = 1, idxValue = 2, idxAlert = -1;

  if (hasHeader) {
    idxSku = header.indexOf("sku");
    idxName = header.indexOf("name");
    const iDelta = header.indexOf("delta");
    const iQty = header.indexOf("qty");
    idxAlert = header.indexOf("alert_qty");
    if (iDelta !== -1) { mode="delta"; idxValue = iDelta; }
    else { mode="set"; idxValue = iQty !== -1 ? iQty : 2; }
    dataRows = rows.slice(1);
  } else {
    mode = "set";
    if (rows[0].length === 2) { idxSku = -1; idxName = 0; idxValue = 1; idxAlert = -1; }
    else if (rows[0].length >= 4) { idxSku = 0; idxName = 1; idxValue = 2; idxAlert = 3; }
    else { idxSku = 0; idxName = 1; idxValue = 2; idxAlert = -1; }
  }

  const existing = await supabaseClient.from("stocks").select("*");
  if (existing.error) return showErr("既存在庫取得失敗", existing.error);

  const bySku = new Map((existing.data||[]).filter(x=>x.sku).map(x => [x.sku, x]));
  const byName = new Map((existing.data||[]).map(x => [x.name, x]));

  setStatus("CSV取り込み中…", true);

  for (let i = 0; i < dataRows.length; i++) {
    const r = dataRows[i];
    const lineNo = hasHeader ? (i + 2) : (i + 1);

    try{
      const sku = idxSku >= 0 ? (r[idxSku] || "").trim() : "";
      const name = (r[idxName] || "").trim();
      const valRaw = (r[idxValue] || "").trim();
      const alertRaw = (idxAlert >= 0) ? (r[idxAlert] || "").trim() : "";

      if (!name && !sku) { countSkipped++; continue; }

      const num = Number(valRaw);
      if (!Number.isFinite(num)) { countSkipped++; pushError(lineNo, `数量が数値ではありません（"${valRaw}"）`); continue; }

      const alertVal = normalizeAlertInput(alertRaw);
      if (alertVal && alertVal.error) { countSkipped++; pushError(lineNo, alertVal.error); continue; }

      const found = sku ? bySku.get(sku) : byName.get(name);

      if (!found) {
        const startQty = num;
        if (startQty <= 0) { countSkipped++; continue; }

        const payload = { sku: sku || null, name: name || "", qty: startQty };
        if (alertVal !== null && idxAlert >= 0) payload.alert_qty = alertVal;

        const ins = await supabaseClient.from("stocks").insert(payload);
        if (ins.error) { pushError(lineNo, `insert失敗（${sku||name}）: ${ins.error.message}`); continue; }

        countInserted++; countProcessed++;

        const hin = await supabaseClient.from("history").insert({
          date: new Date().toISOString(),
          user: currentUser(),
          type: mode === "delta" ? "CSV増減" : "CSV上書き",
          sku: payload.sku,
          name: payload.name,
          qty: Math.abs(startQty)
        });
        if (hin.error) pushError(lineNo, `history失敗: ${hin.error.message}`);
        continue;
      }

      let newQty = (mode === "delta") ? (Number(found.qty) + num) : num;

      if (newQty <= 0) {
        const del = await supabaseClient.from("stocks").delete().eq("id", found.id);
        if (del.error) { pushError(lineNo, `delete失敗（${found.sku||found.name}）: ${del.error.message}`); continue; }
        countDeleted++; countProcessed++;
        if (found.sku) bySku.delete(found.sku);
        byName.delete(found.name);
      } else {
        const payload = { qty: newQty, sku: sku || found.sku || null, name: name || found.name || "" };
        if (idxAlert >= 0 && alertVal !== null) payload.alert_qty = alertVal;

        const up = await supabaseClient.from("stocks").update(payload).eq("id", found.id);
        if (up.error) { pushError(lineNo, `update失敗（${found.sku||found.name}）: ${up.error.message}`); continue; }

        countUpdated++; countProcessed++;

        const updated = { ...found, ...payload };
        if (found.sku && updated.sku !== found.sku) bySku.delete(found.sku);
        if (updated.sku) bySku.set(updated.sku, updated);
        byName.delete(found.name);
        byName.set(updated.name, updated);
      }

      const hin = await supabaseClient.from("history").insert({
        date: new Date().toISOString(),
        user: currentUser(),
        type: mode === "delta" ? "CSV増減" : "CSV上書き",
        sku: (sku || found.sku || null),
        name: (name || found.name || ""),
        qty: Math.abs(num)
      });
      if (hin.error) pushError(lineNo, `history失敗: ${hin.error.message}`);

    }catch(e){
      countSkipped++;
      pushError(lineNo, `例外: ${e?.message || String(e)}`);
    }
  }

  inputEl.value = "";
  await loadAll();

  const summary =
`CSVインポート完了
処理: ${countProcessed}件（insert:${countInserted} / update:${countUpdated} / delete:${countDeleted}）
スキップ: ${countSkipped}件
エラー: ${errors.length}件`;

  if (errors.length) {
    const head = errors.slice(0, 20).join("\n");
    alert(summary + "\n\n--- エラー詳細（最大20件表示） ---\n" + head + (errors.length > 20 ? `\n…他 ${errors.length - 20} 件` : ""));
    setStatus(`CSV完了（エラー ${errors.length}件）`, false);
  } else {
    alert(summary);
    setStatus("CSV完了（エラーなし）", true);
  }
}

/* ========= 棚卸CSV（sku,qty）で上書き ========= */
async function importStocktakeCSV(inputEl){
  if (!checkPin()) { inputEl.value = ""; return; }
  const file = inputEl.files?.[0];
  if (!file) return;

  const text = await file.text();
  const rows = parseCSV(text).map(r => r.map(c => (c ?? "").trim())).filter(r => r.length >= 2);
  if (!rows.length) { alert("CSVが空です"); inputEl.value = ""; return; }

  const header = rows[0].map(x => x.toLowerCase());
  const hasHeader = header.includes("sku") || header.includes("qty");
  let dataRows = rows;
  let idxSku = 0, idxQty = 1;

  if (hasHeader){
    idxSku = header.indexOf("sku");
    idxQty = header.indexOf("qty");
    if (idxSku === -1) idxSku = 0;
    if (idxQty === -1) idxQty = 1;
    dataRows = rows.slice(1);
  }else{
    idxSku = 0; idxQty = 1;
  }

  const existing = await supabaseClient.from("stocks").select("*");
  if (existing.error) return showErr("既存在庫取得失敗", existing.error);

  const bySku = new Map((existing.data||[]).filter(x=>x.sku).map(x => [x.sku, x]));

  let processed = 0, updated = 0, inserted = 0, skipped = 0;
  const errors = [];
  const pushError = (line, msg) => errors.push(`行${line}: ${msg}`);

  setStatus("棚卸取り込み中…", true);

  for (let i=0; i<dataRows.length; i++){
    const r = dataRows[i];
    const lineNo = hasHeader ? (i + 2) : (i + 1);

    const sku = (r[idxSku] || "").trim();
    const qtyRaw = (r[idxQty] || "").trim();
    if (!sku) { skipped++; continue; }

    const qty = Number(qtyRaw);
    if (!Number.isFinite(qty) || qty < 0){
      skipped++; pushError(lineNo, `qtyが不正（"${qtyRaw}"）`); continue;
    }

    const found = bySku.get(sku);
    if (!found){
      // 見つからないSKUは新規追加（商品名なしでOK）
      if (qty <= 0) { skipped++; continue; }
      const ins = await supabaseClient.from("stocks").insert({ sku, name: "", qty });
      if (ins.error){ pushError(lineNo, `insert失敗: ${ins.error.message}`); continue; }
      inserted++; processed++;

      const hin = await supabaseClient.from("history").insert({
        date: new Date().toISOString(),
        user: currentUser(),
        type: "棚卸（新規）",
        sku,
        name: "",
        qty
      });
      if (hin.error) pushError(lineNo, `history失敗: ${hin.error.message}`);
      continue;
    }

    // 既存SKU：qtyを上書き
    const before = Number(found.qty || 0);
    if (before === qty) { processed++; continue; }

    if (qty === 0){
      // 0は削除扱い
      const del = await supabaseClient.from("stocks").delete().eq("id", found.id);
      if (del.error){ pushError(lineNo, `delete失敗: ${del.error.message}`); continue; }
      updated++; processed++;

      const hin = await supabaseClient.from("history").insert({
        date: new Date().toISOString(),
        user: currentUser(),
        type: "棚卸（削除）",
        sku,
        name: found.name || "",
        qty: Math.abs(before - qty)
      });
      if (hin.error) pushError(lineNo, `history失敗: ${hin.error.message}`);
      continue;
    }

    const up = await supabaseClient.from("stocks").update({ qty }).eq("id", found.id);
    if (up.error){ pushError(lineNo, `update失敗: ${up.error.message}`); continue; }
    updated++; processed++;

    const hin = await supabaseClient.from("history").insert({
      date: new Date().toISOString(),
      user: currentUser(),
      type: "棚卸",
      sku,
      name: found.name || "",
      qty: Math.abs(before - qty)
    });
    if (hin.error) pushError(lineNo, `history失敗: ${hin.error.message}`);
  }

  inputEl.value = "";
  await loadAll();

  const summary =
`棚卸CSV完了
処理: ${processed}（update:${updated} / insert:${inserted}）
スキップ: ${skipped}
エラー: ${errors.length}`;

  if (errors.length){
    alert(summary + "\n\n--- エラー詳細（最大20件） ---\n" + errors.slice(0,20).join("\n"));
    setStatus(`棚卸完了（エラー ${errors.length}件）`, false);
  }else{
    alert(summary);
    setStatus("棚卸完了（エラーなし）", true);
  }
}

/* ========= 日時: 東京時間（JST） ========= */
function formatDate(iso){
  try{
    const d = new Date(iso);
    if (isNaN(d.getTime())) return String(iso);

    const parts = new Intl.DateTimeFormat("ja-JP", {
      timeZone: "Asia/Tokyo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    }).formatToParts(d);

    const get = (type) => parts.find(p => p.type === type)?.value || "";
    return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}:${get("second")}`;
  }catch(e){
    return String(iso);
  }
}

/* ========= escaping ========= */
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
function escapeJs(s) {
  return String(s ?? "").replaceAll("\\","\\\\").replaceAll("'","\\'").replaceAll("\n"," ").replaceAll("\r"," ");
}
</script>

</body>
</html>
