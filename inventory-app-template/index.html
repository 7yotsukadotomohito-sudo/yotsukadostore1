<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body { font-family: sans-serif; padding: 30px; }
  input, button { padding: 6px; margin: 4px; }
  table { border-collapse: collapse; margin-bottom: 20px; width: 980px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  .low { background: #ffe5e5; color: #c00; font-weight: bold; }
  #status { padding: 10px; margin: 10px 0; border: 1px solid #ddd; background:#fafafa; }
  .bad { border-color:#f99; background:#fff0f0; }
  .good { border-color:#9f9; background:#f0fff0; }
  .box { border:1px solid #ddd; padding:12px; margin:10px 0; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .small { font-size: 13px; color:#666; }
</style>
</head>

<body>
<h1>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

<div id="status">çŠ¶æ…‹: èµ·å‹•ä¸­â€¦</div>

<div class="box">
  <div class="row">
    <div><b>ç·¨é›†PIN</b>ï¼ˆæ“ä½œã™ã‚‹äººã ã‘å…¥åŠ›ï¼‰</div>
    <input id="pinInput" type="password" placeholder="PIN">
    <span class="small">â€»PINã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«è¨˜æ†¶ã•ã‚Œã¾ã™</span>
  </div>
  <div class="row">
    <span class="small">PINãŒä¸è¦ãªã‚‰ã€ä¸‹ã®EDIT_PINã‚’ç©ºæ–‡å­—ã«ã™ã‚‹ã¨ã€Œèª°ã§ã‚‚ç·¨é›†ã€ã«ãªã‚Šã¾ã™ã€‚</span>
  </div>
</div>

<div class="box">
  <div class="row">
    <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆå±¥æ­´ç”¨ï¼‰ï¼š</div>
    <input id="userInput" placeholder="ä¾‹ï¼šå±±ç”°">
    <span class="small">â€»æœªå…¥åŠ›ã§ã‚‚OK</span>
  </div>
</div>

<div class="box">
  <h2 style="margin:0 0 8px 0;">å…¥åº«</h2>
  <div class="row">
    <input id="nameInput" placeholder="å•†å“å">
    <input id="qtyInput" type="number" placeholder="æ•°é‡">
    <button onclick="addItem()">å…¥åº«</button>
  </div>
</div>

<div class="box">
  <h2 style="margin:0 0 8px 0;">CSV</h2>
  <div class="row">
    <button onclick="exportStocksCSV()">åœ¨åº«CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</button>
    <button onclick="exportHistoryCSV()">å±¥æ­´CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <div><b>åœ¨åº«CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</b>ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</div>
    <input type="file" id="csvInput" accept=".csv,text/csv" onchange="importStocksCSV(this)">
  </div>
  <div class="small">
    CSVå½¢å¼ï¼š<code>name,qty</code><br>
    ä¾‹ï¼š<code>ã‚Šã‚“ã”,10</code> / <code>ã¿ã‹ã‚“,5</code><br>
    â€»ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒã‚ã£ã¦ã‚‚OKï¼ˆname,qtyï¼‰
  </div>
</div>

<h2>åœ¨åº«ä¸€è¦§</h2>
<table id="stockTable"></table>

<h2>å…¥å‡ºåº«å±¥æ­´</h2>
<table id="historyTable"></table>

<script>
/* =========================
   ğŸ”‘ Supabase æ¥ç¶šï¼ˆã‚ãªãŸã®æƒ…å ±å…¥ã‚Šï¼‰
   ========================= */
const SUPABASE_URL = "https://dabhwrkugxxbkvwlcyxi.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYm3NlcyIsInJlZiI6ImRhYmh3cmt1Z3h4Ymt2d2xjeXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjAwNjksImV4cCI6MjA4Mjg5NjA2OX0.G60_QQy0SOY7w-72Mq-gMoq99kUPj1I6c13G2SxOHeQ".replace("supabYm3N","supabase"); // æ–‡å­—åŒ–ã‘å¯¾ç­–ï¼ˆãã®ã¾ã¾å‹•ãï¼‰

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* âœ… ã“ã“ã‚’å¥½ããªPINã«å¤‰æ›´ï¼ˆä¾‹ "7391"ï¼‰ã€‚ç©ºæ–‡å­— "" ã«ã™ã‚‹ã¨PINãªã—é‹ç”¨ */
const EDIT_PIN = "0615";

/* ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ */
const ALERT_QTY = 3;

/* =========================
   UI helpers
   ========================= */
function setStatus(msg, ok=true) {
  const el = document.getElementById("status");
  el.textContent = "çŠ¶æ…‹: " + msg;
  el.className = ok ? "good" : "bad";
}
function showErr(context, err) {
  console.error(context, err);
  const detail = err ? (err.message || JSON.stringify(err)) : "unknown";
  alert(`${context}\n\n${detail}`);
  setStatus(`${context} â†’ ${detail}`, false);
}

function currentUser() {
  return (document.getElementById("userInput").value || "æœªå…¥åŠ›").trim() || "æœªå…¥åŠ›";
}

/* =========================
   PIN è¨˜æ†¶ï¼ˆlocalStorageï¼‰
   ========================= */
function loadSavedPin() {
  const saved = localStorage.getItem("inv_pin") || "";
  document.getElementById("pinInput").value = saved;
}
function savePinOnChange() {
  const el = document.getElementById("pinInput");
  el.addEventListener("input", () => {
    localStorage.setItem("inv_pin", el.value);
  });
}

function checkPin() {
  if (!EDIT_PIN) return true; // PINãªã—é‹ç”¨
  const entered = (document.getElementById("pinInput").value || "").trim();
  if (entered !== EDIT_PIN) {
    alert("PINãŒé•ã„ã¾ã™ï¼ˆæ“ä½œã§ãã¾ã›ã‚“ï¼‰");
    return false;
  }
  return true;
}

/* =========================
   Load & Render
   ========================= */
window.onload = async () => {
  loadSavedPin();
  savePinOnChange();
  setStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
  await loadAll();
};

async function loadAll() {
  const s = await supabaseClient.from("stocks").select("*").order("name");
  if (s.error) return showErr("stocks èª­ã¿è¾¼ã¿å¤±æ•—", s.error);

  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("history èª­ã¿è¾¼ã¿å¤±æ•—", h.error);

  renderStocks(s.data || []);
  renderHistory(h.data || []);
  setStatus("æº–å‚™OKï¼ˆURLé–‹ã‘ã°ã™ãä½¿ãˆã¾ã™ï¼‰", true);
}

function renderStocks(stocks) {
  const table = document.getElementById("stockTable");
  table.innerHTML = "<tr><th>å•†å“</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr>";

  stocks.forEach(s => {
    const tr = table.insertRow();
    if (Number(s.qty) <= ALERT_QTY) tr.className = "low";

    tr.innerHTML = `
      <td>${escapeHtml(s.name)}</td>
      <td>${Number(s.qty)}</td>
      <td>
        <button onclick="shipItem('${escapeJs(s.name)}')">å‡ºåº«</button>
        <button onclick="editQty('${escapeJs(s.name)}', ${Number(s.qty)})">ç·¨é›†</button>
        <button onclick="deleteItem('${escapeJs(s.name)}')">å‰Šé™¤</button>
      </td>
    `;
  });
}

function renderHistory(history) {
  const table = document.getElementById("historyTable");
  table.innerHTML = "<tr><th>æ—¥æ™‚</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>ç¨®åˆ¥</th><th>å•†å“</th><th>æ•°é‡</th></tr>";
  history.forEach(h => {
    const tr = table.insertRow();
    tr.innerHTML = `
      <td>${escapeHtml(h.date)}</td>
      <td>${escapeHtml(h.user)}</td>
      <td>${escapeHtml(h.type)}</td>
      <td>${escapeHtml(h.name)}</td>
      <td>${escapeHtml(String(h.qty))}</td>
    `;
  });
}

/* =========================
   CRUD operations
   ========================= */
async function addItem() {
  if (!checkPin()) return;

  const name = (document.getElementById("nameInput").value || "").trim();
  const qty = Number(document.getElementById("qtyInput").value);
  if (!name || !qty) return alert("å•†å“åã¨æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks æ—¢å­˜ãƒã‚§ãƒƒã‚¯å¤±æ•—", ex.error);

  if (ex.data) {
    const up = await supabaseClient.from("stocks").update({ qty: Number(ex.data.qty) + qty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update å¤±æ•—", up.error);
  } else {
    const ins = await supabaseClient.from("stocks").insert({ name, qty });
    if (ins.error) return showErr("stocks insert å¤±æ•—", ins.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "å…¥åº«",
    name,
    qty
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  document.getElementById("nameInput").value = "";
  document.getElementById("qtyInput").value = "";

  await loadAll();
}

async function shipItem(name) {
  if (!checkPin()) return;

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks å–å¾—å¤±æ•—", ex.error);
  if (!ex.data) return;

  const newQty = Number(ex.data.qty) - 1;
  if (newQty <= 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete å¤±æ•—", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update å¤±æ•—", up.error);
  }

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "å‡ºåº«",
    name,
    qty: 1
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  await loadAll();
}

async function editQty(name, currentQty) {
  if (!checkPin()) return;

  const input = prompt(`åœ¨åº«æ•°ã‚’å¤‰æ›´ã—ã¾ã™ï¼ˆå•†å“: ${name}ï¼‰\nç¾åœ¨: ${currentQty}\næ–°ã—ã„æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`, String(currentQty));
  if (input === null) return;
  const newQty = Number(input);
  if (!Number.isFinite(newQty) || newQty < 0) return alert("0ä»¥ä¸Šã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks å–å¾—å¤±æ•—", ex.error);
  if (!ex.data) return alert("å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

  if (newQty === 0) {
    const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
    if (del.error) return showErr("stocks delete å¤±æ•—", del.error);
  } else {
    const up = await supabaseClient.from("stocks").update({ qty: newQty }).eq("id", ex.data.id);
    if (up.error) return showErr("stocks update å¤±æ•—", up.error);
  }

  const diff = newQty - Number(ex.data.qty);
  const type = diff >= 0 ? "ç·¨é›†ï¼ˆå¢—ï¼‰" : "ç·¨é›†ï¼ˆæ¸›ï¼‰";

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type,
    name,
    qty: Math.abs(diff)
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  await loadAll();
}

async function deleteItem(name) {
  if (!checkPin()) return;
  if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

  const ex = await supabaseClient.from("stocks").select("*").eq("name", name).maybeSingle();
  if (ex.error) return showErr("stocks å–å¾—å¤±æ•—", ex.error);
  if (!ex.data) return;

  const del = await supabaseClient.from("stocks").delete().eq("id", ex.data.id);
  if (del.error) return showErr("stocks delete å¤±æ•—", del.error);

  const hin = await supabaseClient.from("history").insert({
    date: new Date().toISOString(),
    user: currentUser(),
    type: "å‰Šé™¤",
    name,
    qty: 0
  });
  if (hin.error) return showErr("history insert å¤±æ•—", hin.error);

  await loadAll();
}

/* =========================
   CSV Export (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
   ========================= */
function downloadText(filename, text) {
  const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

async function exportStocksCSV() {
  const s = await supabaseClient.from("stocks").select("*").order("name");
  if (s.error) return showErr("åœ¨åº«CSVå–å¾—å¤±æ•—", s.error);

  let csv = "name,qty\n";
  (s.data || []).forEach(r => {
    csv += `${csvEscape(r.name)},${Number(r.qty)}\n`;
  });
  downloadText(`stocks_${todayStr()}.csv`, csv);
}

async function exportHistoryCSV() {
  const h = await supabaseClient.from("history").select("*").order("date", { ascending: false });
  if (h.error) return showErr("å±¥æ­´CSVå–å¾—å¤±æ•—", h.error);

  let csv = "date,user,type,name,qty\n";
  (h.data || []).forEach(r => {
    csv += `${csvEscape(r.date)},${csvEscape(r.user)},${csvEscape(r.type)},${csvEscape(r.name)},${csvEscape(String(r.qty))}\n`;
  });
  downloadText(`history_${todayStr()}.csv`, csv);
}

function todayStr() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}${m}${day}`;
}

/* =========================
   CSV Import (ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
   å½¢å¼: name,qty
   ========================= */
async function importStocksCSV(inputEl) {
  if (!checkPin()) { inputEl.value = ""; return; }

  const file = inputEl.files?.[0];
  if (!file) return;

  const text = await file.text();
  const rows = parseCSV(text);

  // rows: [ [col1, col2, ...], ... ]
  // æœŸå¾…: name,qty
  const cleaned = rows
    .map(r => r.map(c => (c ?? "").trim()))
    .filter(r => r.length >= 2 && r[0] && r[1]);

  // ãƒ˜ãƒƒãƒ€ãƒ¼é™¤å¤–
  const filtered = cleaned.filter(r => !(r[0].toLowerCase() === "name" && r[1].toLowerCase().startsWith("qty")));

  // ç¾åœ¨ã®åœ¨åº«ã‚’ä¸€æ‹¬å–å¾—ï¼ˆé€Ÿåº¦å¯¾ç­–ï¼‰
  const existing = await supabaseClient.from("stocks").select("*");
  if (existing.error) return showErr("æ—¢å­˜åœ¨åº«å–å¾—å¤±æ•—", existing.error);

  const map = new Map((existing.data || []).map(x => [x.name, x]));

  // åæ˜ 
  for (const [nameRaw, qtyRaw] of filtered) {
    const name = nameRaw;
    const qty = Number(qtyRaw);
    if (!name || !Number.isFinite(qty) || qty < 0) continue;

    const found = map.get(name);
    if (found) {
      const up = await supabaseClient.from("stocks").update({ qty }).eq("id", found.id);
      if (up.error) return showErr(`CSVåæ˜ : updateå¤±æ•—ï¼ˆ${name}ï¼‰`, up.error);
    } else {
      const ins = await supabaseClient.from("stocks").insert({ name, qty });
      if (ins.error) return showErr(`CSVåæ˜ : insertå¤±æ•—ï¼ˆ${name}ï¼‰`, ins.error);
    }

    // å±¥æ­´ã«ã‚‚æ®‹ã™ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰
    const hin = await supabaseClient.from("history").insert({
      date: new Date().toISOString(),
      user: currentUser(),
      type: "CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
      name,
      qty
    });
    if (hin.error) return showErr(`CSVåæ˜ : historyå¤±æ•—ï¼ˆ${name}ï¼‰`, hin.error);
  }

  inputEl.value = "";
  await loadAll();
  alert("CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†");
}

/* =========================
   Utils: CSV parse & escape
   ========================= */
function parseCSV(text) {
  // ã‚·ãƒ³ãƒ—ãƒ«CSVãƒ‘ãƒ¼ã‚µï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  for (let i=0; i<text.length; i++) {
    const ch = text[i];
    const next = text[i+1];

    if (ch === '"' ) {
      if (inQ && next === '"') { cur += '"'; i++; }
      else { inQ = !inQ; }
      continue;
    }

    if (!inQ && ch === ",") {
      row.push(cur); cur = "";
      continue;
    }

    if (!inQ && (ch === "\n" || ch === "\r")) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur);
      rows.push(row);
      row = [];
      cur = "";
      continue;
    }

    cur += ch;
  }

  // æœ€çµ‚è¡Œ
  if (cur.length > 0 || row.length > 0) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

function csvEscape(v) {
  const s = String(v ?? "");
  if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
  return s;
}

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

function escapeJs(s) {
  // onclickç”¨ï¼šã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã¨æ”¹è¡Œã‚’æ½°ã™
  return String(s ?? "").replaceAll("\\", "\\\\").replaceAll("'", "\\'").replaceAll("\n", " ").replaceAll("\r"," ");
}
</script>
</body>
</html>
